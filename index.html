<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Iran War: Strait of Hormuz Impact</title>
<meta name="description" content="Interactive dashboard: 20M b/d of oil at risk if Iran closes the Strait of Hormuz. Live prices, bypass capacity, price scenarios, and strategic reserve analysis.">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="Iran War: Strait of Hormuz Impact">
<meta property="og:description" content="20M b/d at risk â€” 20% of global oil. Live Brent/WTI/TTF prices, OPEC+ spare capacity, bypass infrastructure, strategic reserves, and closure scenarios.">
<meta property="og:url" content="https://iran-hormuz-oil.vercel.app/">
<meta property="og:image" content="https://iran-hormuz-oil.vercel.app/thumbnail.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Iran War: Strait of Hormuz Impact">
<meta name="twitter:description" content="20M b/d at risk â€” 20% of global oil. Live crude prices, bypass capacity, strategic reserves, refinery exposure, and closure scenario modeling.">
<meta name="twitter:image" content="https://iran-hormuz-oil.vercel.app/thumbnail.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e63946">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Hormuz Impact">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:ital,wght@0,300;0,400;0,600;1,300&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<style>
  :root {
    --bg: #0a0b0f;
    --panel: #0d0f18;
    --border: #1b2133;
    --accent: #e63946;
    --gold: #f4a261;
    --teal: #2a9d8f;
    --blue: #457b9d;
    --text: #c8cdd8;
    --muted: #5a6278;
    --white: #eef0f7;
    --warn: #ff6b35;
    --green: #52b788;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; overflow: hidden; background: var(--bg); font-family: 'IBM Plex Sans', sans-serif; color: var(--text); }

  .header {
    height: 68px; background: #080a12;
    border-bottom: 2px solid var(--accent);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px; flex-shrink: 0;
  }
  .breaking-badge {
    display: inline-flex; align-items: center; gap: 6px;
    background: var(--accent); color: #fff;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 9px; font-weight: 600; letter-spacing: 2px;
    padding: 2px 9px; border-radius: 2px; margin-right: 14px;
  }
  .breaking-badge::before { content:''; width:6px; height:6px; background:#fff; border-radius:50%; animation:blink 1s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
  .main-title { font-family:'Bebas Neue',sans-serif; font-size:34px; letter-spacing:2px; color:var(--white); line-height:1; }
  .main-title span { color:var(--accent); }
  .subtitle { font-family:'IBM Plex Mono',monospace; font-size:9px; color:var(--muted); letter-spacing:.8px; margin-top:2px; text-transform:uppercase; }
  .datestamp { font-family:'Bebas Neue',sans-serif; font-size:22px; color:var(--gold); letter-spacing:2px; }
  .source-line { font-family:'IBM Plex Mono',monospace; font-size:8px; color:var(--muted); }

  .ticker { height:26px; background:var(--accent); display:flex; align-items:center; overflow:hidden; flex-shrink:0; position:relative; }
  .ticker-label { background:#7a0000; color:#fff; font-family:'IBM Plex Mono',monospace; font-size:9px; font-weight:700; letter-spacing:2px; padding:0 12px; height:100%; display:flex; align-items:center; flex-shrink:0; z-index:1; }
  .ticker-track { flex:1; overflow:hidden; position:relative; }
  .ticker-inner { display:inline-flex; width:max-content; white-space:nowrap; will-change:transform; -webkit-animation:scroll 120s linear infinite; animation:scroll 120s linear infinite; }
  .ticker-inner span { font-family:'IBM Plex Mono',monospace; font-size:10px; color:#fff; font-weight:600; padding:0 30px; display:inline-block; }
  .sep { color:rgba(255,255,255,.35) !important; padding:0 4px !important; display:inline-block; }
  @-webkit-keyframes scroll { 0%{-webkit-transform:translateX(0)} 100%{-webkit-transform:translateX(-50%)} }
  @keyframes scroll { 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }

  .layout { display:flex; height:calc(100vh - 94px); }

  .panel { width:280px; flex-shrink:0; display:flex; flex-direction:column; overflow-y:auto; background:var(--panel); }
  .panel::-webkit-scrollbar { width:2px; }
  .panel::-webkit-scrollbar-thumb { background:var(--border); }
  .panel-l { border-right:1px solid var(--border); }
  .panel-r { border-left:1px solid var(--border); scrollbar-width:none; }
  .panel-r::-webkit-scrollbar { display:none; }

  #rss-feed { scrollbar-width:none; }
  #rss-feed::-webkit-scrollbar { display:none; }

  .sec { padding:13px 15px; border-bottom:1px solid var(--border); }
  .sec-label { font-family:'IBM Plex Mono',monospace; font-size:7.5px; letter-spacing:2px; color:var(--muted); text-transform:uppercase; margin-bottom:9px; display:flex; align-items:center; gap:7px; }
  .sec-label::after { content:''; flex:1; height:1px; background:var(--border); }

  .bignum { font-family:'Bebas Neue',sans-serif; font-size:44px; color:var(--white); line-height:1; }
  .bignum .u { font-family:'IBM Plex Mono',monospace; font-size:14px; color:var(--muted); vertical-align:top; margin-top:7px; display:inline-block; }
  .note { font-family:'IBM Plex Mono',monospace; font-size:8.5px; color:var(--muted); margin-top:2px; }
  .src { font-size:7.5px; color:var(--muted); opacity:.7; }

  .bar-row { margin-bottom:7px; }
  .bar-top { display:flex; justify-content:space-between; font-size:10px; margin-bottom:3px; }
  .bar-val { font-family:'IBM Plex Mono',monospace; font-size:9px; color:var(--gold); }
  .bar-bg { height:4px; background:rgba(255,255,255,.06); border-radius:2px; overflow:hidden; }
  .bar-fg { height:4px; border-radius:2px; width:0; transition:width 1.3s cubic-bezier(.4,0,.2,1); }

  .donut-wrap { display:flex; gap:12px; align-items:center; }
  .leg { flex:1; }
  .leg-row { display:flex; align-items:center; gap:6px; font-size:9.5px; margin-bottom:5px; }
  .dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
  .leg-pct { font-family:'IBM Plex Mono',monospace; font-size:9px; color:var(--gold); margin-left:auto; }

  .pipe { display:grid; grid-template-columns:1fr auto auto; gap:5px; align-items:center; padding:6px 0; border-bottom:1px solid rgba(255,255,255,.04); font-size:9.5px; }
  .pipe-cap { font-family:'IBM Plex Mono',monospace; font-size:8.5px; color:var(--gold); white-space:nowrap; }
  .badge { font-size:7.5px; font-weight:700; letter-spacing:.8px; padding:2px 5px; border-radius:2px; text-transform:uppercase; }
  .b-on  { background:rgba(82,183,136,.2); color:var(--green); }
  .b-lim { background:rgba(244,162,97,.2); color:var(--gold); }
  .b-off { background:rgba(230,57,70,.15); color:var(--accent); }

  .alert { padding:8px 10px; border-left:2px solid var(--accent); background:rgba(230,57,70,.06); margin-bottom:6px; border-radius:0 3px 3px 0; transition:background .2s,border-color .2s,transform .15s; }
  .alert:hover { background:rgba(230,57,70,.12); transform:translateX(2px); }
  .alert.gold { border-color:var(--gold); background:rgba(244,162,97,.06); }
  .alert.gold:hover { background:rgba(244,162,97,.12); }
  .alert.teal { border-color:var(--teal); background:rgba(42,157,143,.06); }
  .alert.teal:hover { background:rgba(42,157,143,.12); }
  .alert-t { font-family:'IBM Plex Mono',monospace; font-size:7.5px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:3px; display:flex; align-items:center; gap:6px; }
  .alert-src { display:inline-block; padding:1px 5px; border-radius:2px; font-size:6.5px; font-weight:700; letter-spacing:.8px; }
  .alert-src.s-bloomberg { background:rgba(255,255,255,.08); color:#f0f0f0; }
  .alert-src.s-aljazeera { background:rgba(250,150,50,.15); color:#f4a261; }
  .alert-src.s-sky { background:rgba(69,123,157,.15); color:#457b9d; }
  .alert-src.s-bbc { background:rgba(187,31,31,.15); color:#e63946; }
  .alert-src.s-reuters { background:rgba(255,130,50,.12); color:#ff6b35; }
  .alert-src.s-guardian { background:rgba(42,157,143,.12); color:#2a9d8f; }
  .alert-src.s-nyt { background:rgba(200,200,200,.1); color:#c8cdd8; }
  .alert-src.s-default { background:rgba(255,255,255,.05); color:var(--muted); }
  .alert-b { font-size:9.5px; color:var(--text); line-height:1.45; }
  .alert-b strong { color:var(--white); }

  .tl { position:relative; padding-left:13px; }
  .tl::before { content:''; position:absolute; left:4px; top:6px; bottom:0; width:1px; background:var(--border); }
  .tl-item { position:relative; margin-bottom:9px; }
  .tl-dot { position:absolute; left:-12px; top:4px; width:7px; height:7px; border-radius:50%; }
  .tl-time { font-family:'IBM Plex Mono',monospace; font-size:7.5px; color:var(--muted); }
  .tl-text { font-size:9.5px; color:var(--text); line-height:1.4; margin-top:1px; }
  .tl-live .tl-time { color:var(--accent); font-weight:700; font-size:8px; }
  .tl-live .tl-text { color:var(--white); font-weight:600; }

  .sg { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
  .sc { background:rgba(255,255,255,.03); border:1px solid var(--border); border-radius:3px; padding:7px 9px; }
  .sc .v { font-family:'Bebas Neue',sans-serif; font-size:24px; color:var(--white); line-height:1; }
  .sc .l { font-family:'IBM Plex Mono',monospace; font-size:7.5px; color:var(--muted); margin-top:1px; text-transform:uppercase; }

  .bypass-callout { margin-top:9px; padding:8px 10px; background:rgba(230,57,70,.08); border:1px solid rgba(230,57,70,.2); border-radius:3px; }
  .bypass-callout .bv { font-family:'Bebas Neue',sans-serif; font-size:28px; color:var(--accent); line-height:1; }
  .bypass-callout .bu { font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--muted); }
  .bypass-callout .bs { font-size:9.5px; color:var(--muted); margin-top:2px; }

  .map-wrap { flex:1; position:relative; }
  #map { width:100%; height:100%; }

  .map-legend {
    position:absolute; bottom:14px; left:10px; z-index:1000;
    background:rgba(8,10,18,.9); border:1px solid var(--border);
    border-radius:4px; padding:9px 13px; backdrop-filter:blur(12px); min-width:175px;
  }
  .ml-title { font-family:'IBM Plex Mono',monospace; font-size:7.5px; color:var(--muted); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:7px; }
  .ml-row { display:flex; align-items:center; gap:8px; margin-bottom:5px; font-size:9.5px; }
  .ml-line { width:22px; height:2px; flex-shrink:0; }
  .ml-dotl { width:9px; height:9px; border-radius:50%; flex-shrink:0; }

  /* Leaflet dark overrides */
  .leaflet-container { background:#07090f !important; }
  .leaflet-control-zoom { border:1px solid var(--border) !important; border-radius:3px !important; }
  .leaflet-control-zoom a { background:var(--panel) !important; color:var(--text) !important; border-bottom:1px solid var(--border) !important; font-weight:400 !important; }
  .leaflet-control-zoom a:hover { background:var(--border) !important; color:var(--white) !important; }
  .leaflet-control-attribution { background:rgba(7,9,15,.75) !important; color:var(--muted) !important; font-size:7px !important; }
  .leaflet-control-attribution a { color:var(--muted) !important; }
  .leaflet-popup-content-wrapper { background:rgba(8,10,18,.92) !important; color:var(--text) !important; border:1px solid var(--border) !important; border-radius:4px !important; box-shadow:none !important; }
  .leaflet-popup-tip { background:rgba(8,10,18,.92) !important; }

  .map-tip { font-family:'IBM Plex Mono',monospace; font-size:10px; }
  .map-tip strong { color:var(--white); font-size:11px; display:block; margin-bottom:2px; font-family:'IBM Plex Mono',monospace; }
  .tip-gold { color:var(--gold); }
  .tip-red { color:var(--accent); }
  .tip-blue { color:#457b9d; }
  .tip-green { color:var(--green); }
  .tip-teal { color:var(--teal); }
  .tip-orange { color:var(--warn); }

  @keyframes pulse-ring {
    0%   { transform:scale(.5); opacity:.9; }
    100% { transform:scale(3); opacity:0; }
  }
  @keyframes pulse-ring2 {
    0%   { transform:scale(.5); opacity:.6; }
    100% { transform:scale(3); opacity:0; }
  }

  /* â”€â”€ NEW: Live Price Ticker â”€â”€ */
  .live-prices { display:flex; gap:6px; margin-bottom:8px; }
  .lp-card { flex:1; background:rgba(255,255,255,.03); border:1px solid var(--border); border-radius:3px; padding:6px 8px; }
  .lp-card.lp-loading { opacity:.5; }
  .lp-ticker { font-family:'IBM Plex Mono',monospace; font-size:7px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; }
  .lp-price { font-family:'Bebas Neue',sans-serif; font-size:22px; color:var(--white); line-height:1.1; margin-top:1px; }
  .lp-change { font-family:'IBM Plex Mono',monospace; font-size:8.5px; font-weight:600; margin-top:1px; }
  .lp-change.up { color:var(--green); }
  .lp-change.down { color:var(--accent); }
  .lp-change.flat { color:var(--muted); }
  .lp-updated { font-family:'IBM Plex Mono',monospace; font-size:7px; color:var(--muted); margin-top:6px; display:flex; align-items:center; gap:5px; }
  .lp-dot { width:5px; height:5px; border-radius:50%; background:var(--green); animation:blink 2s infinite; }
  .lp-dot.stale { background:var(--gold); }
  .lp-dot.error { background:var(--accent); animation:none; }

  /* â”€â”€ NEW: Price Scenario â”€â”€ */
  .ps { background:rgba(255,255,255,.025); border:1px solid var(--border); border-radius:3px; padding:7px 9px; margin-bottom:5px; }
  .ps-label { font-family:'IBM Plex Mono',monospace; font-size:8px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:3px; }
  .ps-prices { display:flex; gap:12px; font-family:'IBM Plex Mono',monospace; font-size:10px; color:var(--text); }
  .ps-prices strong { font-size:12px; }
  .ps-note { font-family:'IBM Plex Mono',monospace; font-size:7.5px; color:var(--muted); margin-top:3px; }
  .ps-pre { border-color:var(--border); }
  .ps-mid { border-color:rgba(244,162,97,.3); }
  .ps-high { border-color:rgba(230,57,70,.3); background:rgba(230,57,70,.04); }
  .ps-ext { border-color:rgba(255,60,60,.4); background:rgba(255,60,60,.06); }
  .contango-box { margin-top:8px; padding:6px 9px; background:rgba(244,162,97,.06); border:1px solid rgba(244,162,97,.15); border-radius:3px; }
  .contango-box .cb-label { font-family:'IBM Plex Mono',monospace; font-size:7.5px; color:var(--gold); text-transform:uppercase; letter-spacing:1px; }
  .contango-box .cb-text { font-family:'IBM Plex Mono',monospace; font-size:8.5px; color:var(--muted); margin-top:2px; }

  /* â”€â”€ NEW: SPR rows â”€â”€ */
  .spr-row { display:grid; grid-template-columns:1fr auto auto; gap:6px; align-items:center; padding:5px 0; border-bottom:1px solid rgba(255,255,255,.04); font-size:9.5px; }
  .spr-val { font-family:'IBM Plex Mono',monospace; font-size:8.5px; color:var(--text); }
  .spr-days { font-family:'IBM Plex Mono',monospace; font-size:8.5px; color:var(--gold); font-weight:600; }

  /* â”€â”€ NEW: Precedent rows â”€â”€ */
  .precedent { padding:6px 0; border-bottom:1px solid rgba(255,255,255,.04); }
  .prec-header { display:flex; justify-content:space-between; align-items:center; }
  .prec-event { font-size:10px; color:var(--white); font-weight:600; }
  .prec-impact { font-family:'IBM Plex Mono',monospace; font-size:10px; font-weight:700; }
  .prec-detail { font-family:'IBM Plex Mono',monospace; font-size:8px; color:var(--muted); margin-top:2px; }

  /* â”€â”€ NEW: Refinery rows â”€â”€ */
  .ref-row { display:grid; grid-template-columns:1fr auto; gap:4px; padding:5px 0; border-bottom:1px solid rgba(255,255,255,.04); font-size:9px; }
  .ref-cap { font-family:'IBM Plex Mono',monospace; font-size:9px; color:var(--gold); text-align:right; }
  .ref-note { font-family:'IBM Plex Mono',monospace; font-size:7.5px; color:var(--muted); grid-column:1/-1; }

  /* â”€â”€ NEW: Timeframe scenario rows â”€â”€ */
  .ts-row { padding:7px 0; border-bottom:1px solid rgba(255,255,255,.04); }
  .ts-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2px; }
  .ts-scenario { font-size:10px; color:var(--white); font-weight:600; }
  .ts-time { font-family:'IBM Plex Mono',monospace; font-size:9px; font-weight:700; }
  .ts-detail { font-family:'IBM Plex Mono',monospace; font-size:8px; color:var(--muted); }

  /* â”€â”€ LIVE TV â”€â”€ */
  .ltv { padding:13px 15px; border-bottom:1px solid var(--border); }
  .ltv-label { font-family:'IBM Plex Mono',monospace; font-size:7.5px; letter-spacing:2px; color:var(--muted); text-transform:uppercase; margin-bottom:9px; display:flex; align-items:center; gap:7px; }
  .ltv-label::after { content:''; flex:1; height:1px; background:var(--border); }
  .ltv-primary { position:relative; width:100%; aspect-ratio:16/9; background:#000; border-radius:3px; overflow:hidden; cursor:pointer; }
  .ltv-primary iframe { width:100%; height:100%; border:0; pointer-events:none; }
  .ltv-primary.interactive iframe { pointer-events:auto; }
  .ltv-overlay { position:absolute; bottom:0; left:0; right:0; padding:6px 8px; background:linear-gradient(transparent, rgba(0,0,0,.85)); display:flex; align-items:center; justify-content:space-between; z-index:2; transition:opacity .3s; }
  .ltv-primary:hover .ltv-overlay { opacity:1; }
  .ltv-ch-name { font-family:'IBM Plex Mono',monospace; font-size:8px; color:#fff; font-weight:600; letter-spacing:1px; text-transform:uppercase; }
  .ltv-live-dot { width:5px; height:5px; border-radius:50%; background:var(--accent); display:inline-block; animation:blink 1s infinite; margin-right:5px; }
  .ltv-live-dot.offline { background:var(--muted); animation:none; }
  .ltv-mute-btn { background:none; border:1px solid rgba(255,255,255,.25); color:#fff; font-family:'IBM Plex Mono',monospace; font-size:7px; letter-spacing:1px; padding:2px 7px; border-radius:2px; cursor:pointer; transition:background .2s, border-color .2s; text-transform:uppercase; }
  .ltv-mute-btn:hover { background:rgba(255,255,255,.1); border-color:rgba(255,255,255,.5); }
  .ltv-mute-btn.unmuted { background:rgba(230,57,70,.2); border-color:var(--accent); color:var(--accent); }
  .ltv-thumbs { display:grid; grid-template-columns:1fr 1fr; gap:4px; margin-top:4px; }
  .ltv-thumb { position:relative; aspect-ratio:16/9; background:#000; border-radius:2px; overflow:hidden; cursor:pointer; border:1px solid transparent; transition:border-color .2s, opacity .2s; opacity:.6; }
  .ltv-thumb:hover { opacity:1; border-color:var(--border); }
  .ltv-thumb.active { opacity:1; border-color:var(--accent); }
  .ltv-thumb iframe { width:100%; height:100%; border:0; pointer-events:none; }
  .ltv-thumb-label { position:absolute; bottom:0; left:0; right:0; padding:2px 5px; background:linear-gradient(transparent, rgba(0,0,0,.9)); font-family:'IBM Plex Mono',monospace; font-size:6.5px; color:rgba(255,255,255,.8); letter-spacing:.8px; text-transform:uppercase; }
  .ltv-loading { display:flex; align-items:center; justify-content:center; position:absolute; inset:0; background:#000; z-index:1; }
  .ltv-loading span { font-family:'IBM Plex Mono',monospace; font-size:8px; color:var(--muted); letter-spacing:1px; }

  /* â”€â”€ Layer Toggle Panel â”€â”€ */
  .layer-toggle {
    position:absolute; top:10px; right:12px; z-index:1000;
    background:rgba(8,10,18,.92); border:1px solid var(--border);
    border-radius:4px; padding:9px 12px; backdrop-filter:blur(12px);
  }
  .lt-title { font-family:'IBM Plex Mono',monospace; font-size:7.5px; color:var(--muted); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:7px; }
  .lt-row { display:flex; align-items:center; gap:7px; margin-bottom:5px; font-size:9.5px; cursor:pointer; }
  .lt-row:last-child { margin-bottom:0; }
  .lt-row input[type="checkbox"] {
    appearance:none; -webkit-appearance:none; width:12px; height:12px; border:1px solid var(--muted);
    border-radius:2px; background:transparent; cursor:pointer; position:relative; flex-shrink:0;
  }
  .lt-row input[type="checkbox"]:checked { background:var(--blue); border-color:var(--blue); }
  .lt-row input[type="checkbox"]:checked::after {
    content:''; position:absolute; top:1px; left:3px; width:4px; height:7px;
    border:solid #fff; border-width:0 1.5px 1.5px 0; transform:rotate(45deg);
  }
  .lt-icon { width:10px; height:10px; flex-shrink:0; display:flex; align-items:center; justify-content:center; }

  /* â”€â”€ MOBILE RESPONSIVE â”€â”€ */
  @media (max-width: 900px) {
    html, body { height: auto; overflow: auto; -webkit-overflow-scrolling: touch; }

    .header {
      height: auto; flex-direction: column; align-items: flex-start;
      padding: 12px 16px; gap: 6px;
    }
    .header-right { text-align: left; }
    .main-title { font-size: 22px; }
    .subtitle { font-size: 8px; }
    .datestamp { font-size: 18px; }
    .breaking-badge { margin-right: 10px; margin-bottom: 2px; }

    .ticker { height: 24px; }
    .ticker-inner span { font-size: 9px; padding: 0 20px; }

    .layout {
      flex-direction: column;
      height: auto;
      min-height: 0;
    }

    .panel {
      width: 100%;
      overflow-y: visible;
      border: none !important;
      border-bottom: 1px solid var(--border) !important;
    }
    .panel-l { order: 1; }
    .map-wrap { order: 2; height: 55vh; min-height: 320px; flex: none; position: relative; }
    #map { width: 100%; height: 55vh; min-height: 320px; }
    .panel-r { order: 3; }

    .sec { padding: 14px 16px; }
    .sec-label { font-size: 8px; }
    .bignum { font-size: 38px; }
    .note { font-size: 9px; }
    .bar-top { font-size: 11px; }
    .bar-val { font-size: 10px; }
    .bar-bg { height: 5px; }
    .bar-fg { height: 5px; }
    .leg-row { font-size: 11px; margin-bottom: 6px; }
    .leg-pct { font-size: 10px; }
    .pipe { font-size: 10.5px; gap: 8px; }
    .pipe-cap { font-size: 9.5px; }

    .live-prices { flex-direction: row; gap: 6px; }
    .lp-price { font-size: 20px; }
    .lp-ticker { font-size: 7px; }
    .lp-change { font-size: 8px; }

    .ps-prices { gap: 10px; font-size: 10px; }
    .ps-prices strong { font-size: 13px; }
    .ps-note { font-size: 8px; }

    .sg { gap: 8px; }
    .sc .v { font-size: 26px; }
    .sc .l { font-size: 8px; }

    .spr-row { font-size: 10.5px; gap: 8px; }
    .spr-val { font-size: 9.5px; }
    .spr-days { font-size: 9.5px; }

    .donut-wrap { gap: 16px; }
    .donut-wrap svg { width: 90px; height: 90px; }

    .ltv { padding: 14px 16px; }
    .ltv-primary { border-radius: 4px; }
    .ltv-ch-name { font-size: 9px; }
    .ltv-mute-btn { font-size: 8px; padding: 3px 9px; }
    .ltv-thumb-label { font-size: 7px; }

    .alert { padding: 10px 12px; }
    .alert-t { font-size: 8px; }
    .alert-b { font-size: 10.5px; }
    #rss-feed { max-height: none !important; }

    .precedent { padding: 8px 0; }
    .prec-event { font-size: 11px; }
    .prec-impact { font-size: 11px; }
    .prec-detail { font-size: 9px; }

    .ref-row { font-size: 10px; padding: 6px 0; }
    .ref-cap { font-size: 10px; }
    .ref-note { font-size: 8px; }

    .ts-row { padding: 8px 0; }
    .ts-scenario { font-size: 11px; }
    .ts-time { font-size: 10px; }
    .ts-detail { font-size: 9px; }

    .tl-time { font-size: 8px; }
    .tl-text { font-size: 10.5px; }

    .bypass-callout { padding: 10px 12px; }
    .bypass-callout .bv { font-size: 30px; }
    .contango-box .cb-text { font-size: 9px; }

    .map-legend { bottom: 8px; left: 6px; padding: 7px 10px; min-width: 150px; }
    .ml-row { font-size: 9px; }
    .layer-toggle { top: 8px; right: 6px; padding: 7px 10px; }
    .lt-row { font-size: 9px; }
  }

  @media (max-width: 480px) {
    .header { padding: 10px 12px; }
    .main-title { font-size: 18px; letter-spacing: 1px; }
    .subtitle { font-size: 7px; letter-spacing: .5px; }
    .datestamp { font-size: 16px; }
    .source-line { font-size: 7px; }

    .live-prices { flex-direction: column; gap: 5px; }
    .lp-card { display: flex; align-items: center; gap: 10px; padding: 8px 10px; }
    .lp-ticker { min-width: 65px; }
    .lp-price { font-size: 22px; margin-top: 0; }
    .lp-change { margin-top: 0; margin-left: auto; }

    .map-wrap { height: 45vh; min-height: 280px; }

    .sec { padding: 12px 14px; }
    .sg { grid-template-columns: 1fr 1fr; gap: 6px; }
  }
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;align-items:center">
    <span class="breaking-badge">Breaking</span>
    <div>
      <div class="main-title">IRAN WAR: <span>STRAIT OF HORMUZ</span> IMPACT</div>
      <div class="subtitle">US &amp; Israel launch joint military strikes Â· Iran retaliates across the Middle East</div>
    </div>
  </div>
  <div class="header-right">
    <div class="datestamp" id="live-utc"></div>
    <div class="source-line">EIA Â· IEA Â· Vortexa Â· S&amp;P Global Platts Â· Lloyd's Â· ONI Â· AP Â· Reuters Â· Al Jazeera</div>
  </div>
</div>

<div class="ticker">
  <div class="ticker-label">ASSESSMENT</div>
  <div class="ticker-track"><div class="ticker-inner" id="ticker-inner">
    <span>Hormuz: 20M b/d at risk = 20% of global oil consumption + 27% of seaborne trade (EIA)</span>
    <span class="sep">///</span>
    <span>OPEC+ spare capacity only ~3.5M b/d â€” cannot offset a full Hormuz closure (EIA 2024)</span>
    <span class="sep">///</span>
    <span>Bypass capacity: only ~2.6M b/d available â€” 13% of Hormuz volume (S&amp;P Platts)</span>
    <span class="sep">///</span>
    <span>84% of Hormuz crude destined for Asia Â· China/India/Japan/S.Korea = 69% (EIA 2024)</span>
    <span class="sep">///</span>
    <span>Qatar's 106 MTPA LNG capacity transits Hormuz â€” 20% of global LNG at risk (IGU 2024)</span>
    <span class="sep">///</span>
    <span>IEA coordinated SPR max drawdown: ~4.4M b/d vs 20M at risk â€” reserves buy weeks, not months (IEA)</span>
    <span class="sep">///</span>
    <span>Iran stockpiles ~6,000 naval mines â€” full Hormuz clearance est. 4-8 weeks minimum (US Navy / ONI)</span>
    <span class="sep">///</span>
    <span id="ticker-brent"></span>
    <span class="sep">///</span>
    <span id="ticker-wti"></span>
    <span class="sep">///</span>
    <span id="ticker-ttf"></span>
    <span class="sep">///</span>
    <span>Hormuz: 20M b/d at risk = 20% of global oil consumption + 27% of seaborne trade (EIA)</span>
    <span class="sep">///</span>
    <span>OPEC+ spare capacity only ~3.5M b/d â€” cannot offset a full Hormuz closure (EIA 2024)</span>
    <span class="sep">///</span>
    <span>Bypass capacity: only ~2.6M b/d available â€” 13% of Hormuz volume (S&amp;P Platts)</span>
    <span class="sep">///</span>
    <span>84% of Hormuz crude destined for Asia Â· China/India/Japan/S.Korea = 69% (EIA 2024)</span>
    <span class="sep">///</span>
    <span>Qatar's 106 MTPA LNG capacity transits Hormuz â€” 20% of global LNG at risk (IGU 2024)</span>
    <span class="sep">///</span>
    <span>IEA coordinated SPR max drawdown: ~4.4M b/d vs 20M at risk â€” reserves buy weeks, not months (IEA)</span>
    <span class="sep">///</span>
    <span>Iran stockpiles ~6,000 naval mines â€” full Hormuz clearance est. 4-8 weeks minimum (US Navy / ONI)</span>
    <span class="sep">///</span>
    <span id="ticker-brent2"></span>
    <span class="sep">///</span>
    <span id="ticker-wti2"></span>
    <span class="sep">///</span>
    <span id="ticker-ttf2"></span>
  </div></div>
</div>

<div class="layout">

  <!-- LEFT PANEL -->
  <div class="panel panel-l">
    <div class="sec">
      <div class="sec-label">Daily Oil Transit â€” Hormuz</div>
      <div class="bignum">20 <span class="u">M b/d</span></div>
      <div class="note">â‰ˆ 20% of global petroleum consumption <span class="src">(EIA 2024)</span></div>
      <div class="note" style="margin-top:2px">â‰ˆ 27% of global seaborne oil trade <span class="src">(EIA 2024)</span></div>
    </div>

    <!-- LIVE PRICES + PRICE IMPACT -->
    <div class="sec">
      <div class="sec-label">
        <span style="display:flex;align-items:center;gap:6px;flex:1">
          <span id="lp-status-dot" class="lp-dot"></span>
          Live Commodity Prices
        </span>
        <span id="lp-timestamp" style="font-size:7px;color:var(--muted);white-space:nowrap"></span>
      </div>
      <div class="live-prices" id="live-prices">
        <div class="lp-card lp-loading" id="lp-brent">
          <div class="lp-ticker">Brent (BZ=F)</div>
          <div class="lp-price" id="lp-brent-price">--</div>
          <div class="lp-change flat" id="lp-brent-change">loading...</div>
        </div>
        <div class="lp-card lp-loading" id="lp-wti">
          <div class="lp-ticker">WTI (CL=F)</div>
          <div class="lp-price" id="lp-wti-price">--</div>
          <div class="lp-change flat" id="lp-wti-change">loading...</div>
        </div>
        <div class="lp-card lp-loading" id="lp-ttf">
          <div class="lp-ticker">TTF Gas (TTF=F)</div>
          <div class="lp-price" id="lp-ttf-price">--</div>
          <div class="lp-change flat" id="lp-ttf-change">loading...</div>
        </div>
      </div>
      <div class="note"><span class="src">Yahoo Finance Â· Auto-refreshes every 60s</span></div>
    </div>

    <div class="sec">
      <div class="sec-label">Hormuz Closure â€” Price Scenarios</div>
      <div class="ps ps-mid" id="ps-partial">
        <div class="ps-label">Partial Disruption (1-2 weeks)</div>
        <div class="ps-prices" id="ps-partial-prices">
          <span>Brent <strong style="color:var(--gold)">$95â€“110</strong></span>
          <span>WTI <strong style="color:var(--gold)">$90â€“105</strong></span>
        </div>
        <div class="ps-note" id="ps-partial-note">+25-45% Â· Harassment, not full blockade Â· Naval escorts, SPR release Â· Abqaiq 2019 analog Ã—3</div>
      </div>
      <div class="ps ps-high" id="ps-full">
        <div class="ps-label">Full Blockade (1-3 months)</div>
        <div class="ps-prices" id="ps-full-prices">
          <span>Brent <strong style="color:var(--accent)">$120â€“155</strong></span>
          <span>WTI <strong style="color:var(--accent)">$115â€“150</strong></span>
        </div>
        <div class="ps-note" id="ps-full-note">+55-100% Â· Mining/interdiction of lanes Â· Kuwait 1990 analog Â· Demand destruction onset ~$130-150</div>
      </div>
      <div class="ps ps-ext" id="ps-extended">
        <div class="ps-label">Extended Regional War (3+ months)</div>
        <div class="ps-prices" id="ps-extended-prices">
          <span>Brent <strong style="color:#ff4444">$150â€“200+</strong></span>
          <span>WTI <strong style="color:#ff4444">$145â€“195+</strong></span>
        </div>
        <div class="ps-note" id="ps-extended-note">+90-170% Â· Infrastructure destroyed Â· 1973 embargo analog Â· Rationing / recession</div>
      </div>
      <div class="contango-box">
        <div class="cb-label">Futures Curve: Severe Backwardation</div>
        <div class="cb-text">Near-term contracts at premium to deferred â€” market pricing physical shortage risk. Degree depends on closure duration: short disruption = $5-15 backwardation; full blockade = $20-40+ front-month premium over 12-month.</div>
      </div>
      <div class="note" style="margin-top:5px"><span class="src">(Goldman Sachs / JP Morgan crisis models Â· EIA disruption scenarios)</span></div>
    </div>

    <div class="sec">
      <div class="sec-label">Crude Origin â€” 2024 <span class="src" style="margin-left:auto">(EIA)</span></div>
      <div class="bar-row">
        <div class="bar-top"><span>ðŸ‡¸ðŸ‡¦ Saudi Arabia</span><span class="bar-val">5.5M b/d Â· 38%</span></div>
        <div class="bar-bg"><div class="bar-fg" data-w="76" style="background:#f4a261"></div></div>
      </div>
      <div class="bar-row">
        <div class="bar-top"><span>ðŸ‡®ðŸ‡¶ Iraq</span><span class="bar-val">3.4M b/d Â· 23%</span></div>
        <div class="bar-bg"><div class="bar-fg" data-w="46" style="background:#e76f51"></div></div>
      </div>
      <div class="bar-row">
        <div class="bar-top"><span>ðŸ‡¦ðŸ‡ª UAE</span><span class="bar-val">2.1M b/d Â· 14%</span></div>
        <div class="bar-bg"><div class="bar-fg" data-w="28" style="background:#2a9d8f"></div></div>
      </div>
      <div class="bar-row">
        <div class="bar-top"><span>ðŸ‡°ðŸ‡¼ Kuwait</span><span class="bar-val">1.7M b/d Â· 12%</span></div>
        <div class="bar-bg"><div class="bar-fg" data-w="22" style="background:#457b9d"></div></div>
      </div>
      <div class="bar-row">
        <div class="bar-top"><span>ðŸ‡®ðŸ‡· Iran</span><span class="bar-val">1.3M b/d Â· 9%</span></div>
        <div class="bar-bg"><div class="bar-fg" data-w="18" style="background:#e63946"></div></div>
      </div>
      <div class="bar-row">
        <div class="bar-top"><span>ðŸ‡¶ðŸ‡¦ Qatar (LNG)</span><span class="bar-val">~20% global LNG</span></div>
        <div class="bar-bg"><div class="bar-fg" data-w="10" style="background:#a8dadc"></div></div>
      </div>
    </div>

    <div class="sec">
      <div class="sec-label">Crude Destination â€” 2024 <span class="src" style="margin-left:auto">(EIA)</span></div>
      <div class="donut-wrap">
        <svg width="78" height="78" viewBox="0 0 78 78">
          <circle cx="39" cy="39" r="27" fill="none" stroke="#1b2133" stroke-width="13"/>
          <circle cx="39" cy="39" r="27" fill="none" stroke="#e63946" stroke-width="13"
            stroke-dasharray="45.6 169.6" stroke-dashoffset="0" transform="rotate(-90 39 39)"/>
          <circle cx="39" cy="39" r="27" fill="none" stroke="#f4a261" stroke-width="13"
            stroke-dasharray="27.1 169.6" stroke-dashoffset="-45.6" transform="rotate(-90 39 39)"/>
          <circle cx="39" cy="39" r="27" fill="none" stroke="#2a9d8f" stroke-width="13"
            stroke-dasharray="23.7 169.6" stroke-dashoffset="-72.7" transform="rotate(-90 39 39)"/>
          <circle cx="39" cy="39" r="27" fill="none" stroke="#457b9d" stroke-width="13"
            stroke-dasharray="20.4 169.6" stroke-dashoffset="-96.4" transform="rotate(-90 39 39)"/>
          <circle cx="39" cy="39" r="27" fill="none" stroke="#a8dadc" stroke-width="13"
            stroke-dasharray="25.4 169.6" stroke-dashoffset="-116.8" transform="rotate(-90 39 39)"/>
          <circle cx="39" cy="39" r="27" fill="none" stroke="#3a4257" stroke-width="13"
            stroke-dasharray="27.1 169.6" stroke-dashoffset="-142.2" transform="rotate(-90 39 39)"/>
          <text x="39" y="37" text-anchor="middle" fill="#eef0f7" font-family="Bebas Neue" font-size="12">84%</text>
          <text x="39" y="46" text-anchor="middle" fill="#5a6278" font-family="IBM Plex Mono" font-size="6">ASIA</text>
        </svg>
        <div class="leg">
          <div class="leg-row"><div class="dot" style="background:#e63946"></div>China<span class="leg-pct">27%</span></div>
          <div class="leg-row"><div class="dot" style="background:#f4a261"></div>India<span class="leg-pct">16%</span></div>
          <div class="leg-row"><div class="dot" style="background:#2a9d8f"></div>Japan<span class="leg-pct">14%</span></div>
          <div class="leg-row"><div class="dot" style="background:#457b9d"></div>S. Korea<span class="leg-pct">12%</span></div>
          <div class="leg-row"><div class="dot" style="background:#a8dadc"></div>Other Asia<span class="leg-pct">15%</span></div>
          <div class="leg-row"><div class="dot" style="background:#3a4257"></div>Rest of World<span class="leg-pct">16%</span></div>
        </div>
      </div>
    </div>

    <div class="sec">
      <div class="sec-label">Global Exposure</div>
      <div class="sg">
        <div class="sc"><div class="v" style="color:#e63946">20%</div><div class="l">Global oil supply</div></div>
        <div class="sc"><div class="v" style="color:#f4a261">27%</div><div class="l">Seaborne trade</div></div>
        <div class="sc"><div class="v" style="color:#2a9d8f">20%</div><div class="l">Global LNG</div></div>
        <div class="sc"><div class="v" style="color:#ff6b35">2%</div><div class="l">US consumption</div></div>
      </div>
    </div>

    <!-- NEW: OPEC+ SPARE CAPACITY -->
    <div class="sec">
      <div class="sec-label">OPEC+ Spare Production Capacity <span class="src" style="margin-left:auto">(EIA 2024)</span></div>
      <div class="bignum" style="font-size:36px">~3.5 <span class="u">M b/d</span></div>
      <div class="note">Saudi Arabia ~2M Â· UAE ~1M Â· Others ~0.5M</div>
      <div class="bypass-callout" style="margin-top:8px">
        <div style="font-size:9.5px;color:var(--text);line-height:1.45">
          <strong style="color:var(--accent)">Critical gap:</strong> Spare capacity covers only 17.5% of Hormuz flow. And most Gulf spare capacity normally ships <em>through</em> Hormuz â€” it needs bypass routes to reach market.
        </div>
      </div>
    </div>

    <!-- NEW: LNG EXPANDED -->
    <div class="sec">
      <div class="sec-label">LNG Exposure â€” Hormuz <span class="src" style="margin-left:auto">(IGU 2024)</span></div>
      <div class="bignum" style="font-size:32px">~20% <span class="u">of global LNG</span></div>
      <div class="note" style="margin-top:3px">Qatar: 106 MTPA â€” virtually all transits Hormuz</div>
      <div style="margin-top:8px">
        <div class="bar-row">
          <div class="bar-top"><span>TTF (Europe gas)</span><span class="bar-val">â‚¬28 â†’ â‚¬80-120/MWh</span></div>
          <div class="bar-bg"><div class="bar-fg bar-fg-delayed" data-w="75" style="background:var(--gold)"></div></div>
        </div>
        <div class="bar-row">
          <div class="bar-top"><span>JKM (Asia LNG)</span><span class="bar-val">$12 â†’ $35-55/MMBtu</span></div>
          <div class="bar-bg"><div class="bar-fg bar-fg-delayed" data-w="82" style="background:var(--accent)"></div></div>
        </div>
      </div>
      <div class="note" style="margin-top:4px">Europe still rebuilding from 2022 gas crisis. Asian spot buyers (Bangladesh, Pakistan) priced out first. Japan/Korea face acute winter shortfalls.</div>
    </div>

    <div class="sec">
      <div class="sec-label">Bypass Infrastructure</div>
      <div class="pipe" style="font-family:'IBM Plex Mono',monospace;font-size:7.5px;color:var(--muted)"><span>Pipeline</span><span>Cap.</span><span>Status</span></div>
      <div class="pipe">
        <div><div>ðŸ‡¸ðŸ‡¦ Saudi E-W Pipeline</div><div style="font-size:8px;color:var(--muted)">Abqaiq â†’ Yanbu (Red Sea)</div></div>
        <div class="pipe-cap">5M b/d</div><div class="badge b-on">Active</div>
      </div>
      <div class="pipe">
        <div><div>ðŸ‡¦ðŸ‡ª UAE Fujairah</div><div style="font-size:8px;color:var(--muted)">Habshan â†’ Fujairah (Gulf of Oman)</div></div>
        <div class="pipe-cap">1.8M b/d</div><div class="badge b-lim">Limited</div>
      </div>
      <div class="pipe">
        <div><div>ðŸ‡®ðŸ‡· Goreh-Jask</div><div style="font-size:8px;color:var(--muted)">Goreh â†’ Jask (Gulf of Oman)</div></div>
        <div class="pipe-cap">300K b/d</div><div class="badge b-off">Inactive</div>
      </div>
      <div class="bypass-callout">
        <div style="font-family:'IBM Plex Mono',monospace;font-size:7.5px;color:var(--muted);margin-bottom:3px">Available Bypass Capacity <span class="src">(EIA / S&amp;P Platts)</span></div>
        <div class="bv">~2.6M <span class="bu">b/d</span></div>
        <div class="bs">vs 20M transiting â€” <strong style="color:var(--accent)">only 13% covered</strong></div>
        <div class="note" style="margin-top:3px">E-W running ~2.4M spare Â· Fujairah near capacity Â· Jask offline since Sep 2024. Ramp-up time: days to weeks for Saudi E-W, Fujairah cannot scale.</div>
      </div>
    </div>

    <!-- NEW: STRATEGIC RESERVES -->
    <div class="sec">
      <div class="sec-label">Strategic Petroleum Reserves <span class="src" style="margin-left:auto">(IEA 2024)</span></div>
      <div class="spr-row" style="font-family:'IBM Plex Mono',monospace;font-size:7.5px;color:var(--muted);border:none;padding-bottom:2px">
        <span>Country</span><span>Volume</span><span>Cover</span>
      </div>
      <div class="spr-row"><span>ðŸ‡ºðŸ‡¸ United States</span><span class="spr-val">~395M bbl</span><span class="spr-days">~45 days</span></div>
      <div class="spr-row"><span>ðŸ‡¨ðŸ‡³ China</span><span class="spr-val">~950M bbl</span><span class="spr-days">~80 days</span></div>
      <div class="spr-row"><span>ðŸ‡¯ðŸ‡µ Japan</span><span class="spr-val">~470M bbl</span><span class="spr-days">~150 days</span></div>
      <div class="spr-row"><span>ðŸ‡ªðŸ‡º Europe (IEA)</span><span class="spr-val">~1.2B bbl</span><span class="spr-days">~90 days</span></div>
      <div class="spr-row"><span>ðŸ‡°ðŸ‡· South Korea</span><span class="spr-val">~96M bbl</span><span class="spr-days">~90 days</span></div>
      <div class="spr-row"><span>ðŸ‡®ðŸ‡³ India</span><span class="spr-val">~40M bbl</span><span class="spr-days">~10 days</span></div>
      <div class="bypass-callout" style="margin-top:8px;background:rgba(244,162,97,.06);border-color:rgba(244,162,97,.2)">
        <div style="font-size:9px;color:var(--text);line-height:1.4">
          <strong style="color:var(--gold)">Reserves buy time, not salvation.</strong> IEA coordinated drawdown max: ~4.4M b/d â€” vs 20M at risk. India's 10-day cover most exposed. China's opaque reserves may overstate readiness.
        </div>
      </div>
    </div>

  </div>

  <!-- MAP -->
  <div class="map-wrap">
    <div id="map"></div>
    <div class="map-legend">
      <div class="ml-title">Map Legend</div>
      <div class="ml-row">
        <svg width="22" height="4"><line x1="0" y1="2" x2="22" y2="2" stroke="#f4a261" stroke-width="2" stroke-dasharray="6,3"/></svg>
        <span style="color:#f4a261">Tanker route</span>
      </div>
      <div class="ml-row">
        <svg width="22" height="4"><line x1="0" y1="2" x2="22" y2="2" stroke="#52b788" stroke-width="2" stroke-dasharray="5,3"/></svg>
        <span style="color:#52b788">Saudi E-W pipeline</span>
      </div>
      <div class="ml-row">
        <svg width="22" height="4"><line x1="0" y1="2" x2="22" y2="2" stroke="#2a9d8f" stroke-width="2" stroke-dasharray="4,3"/></svg>
        <span style="color:#2a9d8f">UAE Fujairah bypass</span>
      </div>
      <div class="ml-row">
        <svg width="22" height="4"><line x1="0" y1="2" x2="22" y2="2" stroke="#5a6278" stroke-width="2" stroke-dasharray="3,4"/></svg>
        <span style="color:#5a6278">Goreh-Jask (inactive)</span>
      </div>
      <div style="height:5px"></div>
      <div class="ml-row"><div class="ml-dotl" style="background:#e63946"></div><span>US/Israeli airstrike</span></div>
      <div class="ml-row"><div class="ml-dotl" style="background:#ff6b35"></div><span>Iranian counter-strike</span></div>
      <div class="ml-row"><div class="ml-dotl" style="background:#457b9d"></div><span>US naval asset</span></div>
      <div class="ml-row"><div class="ml-dotl" style="background:#52b788"></div><span>Pipeline terminal</span></div>
      <div style="height:5px"></div>
      <div class="ml-row"><div class="ml-dotl" style="background:#6a8caf;transform:rotate(45deg);border-radius:1px;width:8px;height:8px"></div><span style="color:#6a8caf">Military base</span></div>
      <div class="ml-row"><div class="ml-dotl" style="background:#c77dff"></div><span style="color:#c77dff">Nuclear facility</span></div>
      <div class="ml-row"><div class="ml-dotl" style="background:#ff4500;width:6px;height:6px"></div><span style="color:#ff4500">Fire hotspot</span></div>
      <div class="ml-row"><div class="ml-dotl" style="background:#ffd166;width:6px;height:6px;border:1px solid #f4a261"></div><span style="color:#ffd166">Earthquake</span></div>
    </div>
    <!-- Layer Toggle Panel -->
    <div class="layer-toggle">
      <div class="lt-title">Data Layers</div>
      <label class="lt-row"><input type="checkbox" id="tog-bases" checked><div class="lt-icon"><div style="width:8px;height:8px;background:#6a8caf;transform:rotate(45deg);border-radius:1px"></div></div><span style="color:#6a8caf">Military Bases</span></label>
      <label class="lt-row"><input type="checkbox" id="tog-nuclear" checked><div class="lt-icon"><div style="width:8px;height:8px;border-radius:50%;background:#c77dff"></div></div><span style="color:#c77dff">Nuclear Sites</span></label>
      <label class="lt-row"><input type="checkbox" id="tog-fires" checked><div class="lt-icon"><div style="width:6px;height:6px;border-radius:50%;background:#ff4500"></div></div><span style="color:#ff4500">Fires (FIRMS)</span></label>
      <label class="lt-row"><input type="checkbox" id="tog-quakes" checked><div class="lt-icon"><div style="width:6px;height:6px;border-radius:50%;background:#ffd166;border:1px solid #f4a261"></div></div><span style="color:#ffd166">Earthquakes</span></label>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="panel panel-r">

    <!-- LIVE TV -->
    <div class="ltv">
      <div class="ltv-label">
        <span style="display:flex;align-items:center;gap:5px"><span class="ltv-live-dot" id="ltv-dot"></span>LIVE TV</span>
      </div>
      <div class="ltv-primary" id="ltv-primary" onclick="toggleLtvMute()">
        <div class="ltv-loading" id="ltv-loading"><span>Connecting...</span></div>
        <div id="ltv-player-primary"></div>
        <div class="ltv-overlay">
          <span class="ltv-ch-name" id="ltv-primary-name">Bloomberg</span>
          <button class="ltv-mute-btn unmuted" id="ltv-mute-btn" onclick="event.stopPropagation();toggleLtvMute()">Mute</button>
        </div>
      </div>
      <div class="ltv-thumbs">
        <div class="ltv-thumb" id="ltv-thumb-0" onclick="swapLtvChannel(0)">
          <div id="ltv-player-thumb0"></div>
          <div class="ltv-thumb-label" id="ltv-thumb-label-0">Al Jazeera</div>
        </div>
        <div class="ltv-thumb" id="ltv-thumb-1" onclick="swapLtvChannel(1)">
          <div id="ltv-player-thumb1"></div>
          <div class="ltv-thumb-label" id="ltv-thumb-label-1">Sky News</div>
        </div>
      </div>
    </div>

    <!-- LIVE WIRE (Headlines) -->
    <div class="sec" style="flex-shrink:0">
      <div class="sec-label" style="margin-bottom:8px">
        <span style="display:flex;align-items:center;gap:6px;flex:1">
          <span id="rss-dot" style="width:6px;height:6px;border-radius:50%;background:#e63946;display:inline-block;animation:blink 1s infinite;flex-shrink:0"></span>
          LIVE WIRE
        </span>
        <span id="rss-updated" style="font-size:7px;color:var(--muted);font-family:'IBM Plex Mono',monospace;white-space:nowrap"></span>
      </div>
      <div id="rss-feed" style="max-height:400px;overflow-y:auto">
        <div style="padding:16px 0;text-align:center;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--muted)">
          âŸ³ Fetching live headlines...
        </div>
      </div>
      <div id="rss-error" style="display:none;padding:8px 0;font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted)"></div>
    </div>


    <!-- HISTORICAL PRECEDENTS -->
    <div class="sec">
      <div class="sec-label">Historical Precedents</div>
      <div class="precedent">
        <div class="prec-header">
          <span class="prec-event">1973 Arab Oil Embargo</span>
          <span class="prec-impact" style="color:var(--accent)">+300%</span>
        </div>
        <div class="prec-detail">$3â†’$12/bbl Â· US gas lines Â· Reshaped global energy policy for decades</div>
      </div>
      <div class="precedent">
        <div class="prec-header">
          <span class="prec-event">1984-88 Tanker War</span>
          <span class="prec-impact" style="color:var(--gold)">Sustained</span>
        </div>
        <div class="prec-detail">546 ships attacked Â· Insurance 500x Â· US "reflagging" operations in Gulf</div>
      </div>
      <div class="precedent">
        <div class="prec-header">
          <span class="prec-event">1990 Kuwait Invasion</span>
          <span class="prec-impact" style="color:var(--accent)">+130%</span>
        </div>
        <div class="prec-detail">Oil doubled in 2 months Â· $21â†’$46 Â· 4.3M b/d offline Â· SPR released</div>
      </div>
      <div class="precedent">
        <div class="prec-header">
          <span class="prec-event">2019 Abqaiq Attack</span>
          <span class="prec-impact" style="color:var(--gold)">+15%</span>
        </div>
        <div class="prec-detail">5.7M b/d offline Â· Largest single disruption ever Â· Recovered in weeks</div>
      </div>
      <div class="precedent">
        <div class="prec-header">
          <span class="prec-event">2023-24 Houthi Red Sea</span>
          <span class="prec-impact" style="color:var(--teal)">+300% freight</span>
        </div>
        <div class="prec-detail">Suez transits -50% Â· Cape reroute adds 10-14 days Â· Still ongoing</div>
      </div>
      <div class="note" style="margin-top:6px">Hormuz closure dwarfs all precedents: 20M b/d vs Abqaiq's 5.7M or Kuwait's 4.3M. No modern equivalent exists.</div>
    </div>

    <!-- INSURANCE & FREIGHT -->
    <div class="sec">
      <div class="sec-label">Insurance &amp; Freight Impact <span class="src" style="margin-left:auto">(Lloyd's)</span></div>
      <div class="sg">
        <div class="sc">
          <div class="v" style="color:var(--accent);font-size:20px">5-10%</div>
          <div class="l">War-risk premium<br><span style="font-size:6.5px;opacity:.7">vs 0.05% normal</span></div>
        </div>
        <div class="sc">
          <div class="v" style="color:var(--gold);font-size:20px">$200K+</div>
          <div class="l">VLCC daily rate<br><span style="font-size:6.5px;opacity:.7">vs ~$35K normal</span></div>
        </div>
      </div>
      <div class="note" style="margin-top:6px">War-risk on $100M hull = $5-10M per transit. Tanker owners refusing Hormuz passage. BDTI index expected to spike 500%+. 1984 Tanker War premiums were 100x â€” this would be worse.</div>
    </div>

    <!-- CONSUMER IMPACT -->
    <div class="sec">
      <div class="sec-label">Consumer Impact â€” Who Pays</div>
      <div class="sg">
        <div class="sc">
          <div class="v" style="color:var(--accent);font-size:20px">$5-7</div>
          <div class="l">US gasoline/gal<br><span style="font-size:6.5px;opacity:.7">vs $3.20 today</span></div>
        </div>
        <div class="sc">
          <div class="v" style="color:var(--gold);font-size:20px">2-3M</div>
          <div class="l">b/d demand destroyed</div>
        </div>
        <div class="sc">
          <div class="v" style="color:var(--warn);font-size:20px">60-80%</div>
          <div class="l">Recession probability</div>
        </div>
        <div class="sc">
          <div class="v" style="color:var(--teal);font-size:20px">2-4%</div>
          <div class="l">GDP hit (importers)</div>
        </div>
      </div>
      <div class="note" style="margin-top:6px">Every $10/bbl increase â‰ˆ 0.2% off global GDP. At $180 Brent (+$100), equivalent to ~2% GDP shock. Developing Asian economies and oil-import-dependent nations (India, Japan, Turkey) hit hardest.</div>
    </div>

    <!-- REFINERY DEPENDENCY -->
    <div class="sec">
      <div class="sec-label">Downstream â€” Key Refineries at Risk <span class="src" style="margin-left:auto">(Platts)</span></div>
      <div class="ref-row" style="font-family:'IBM Plex Mono',monospace;font-size:7.5px;color:var(--muted);border:none;padding-bottom:0"><span>Facility</span><span>Capacity</span></div>
      <div class="ref-row">
        <span>ðŸ‡®ðŸ‡³ Jamnagar (Reliance)</span><span class="ref-cap">1.4M b/d</span>
        <span class="ref-note">World's largest refinery Â· ~100% Gulf crude</span>
      </div>
      <div class="ref-row">
        <span>ðŸ‡°ðŸ‡· SK Ulsan</span><span class="ref-cap">840K b/d</span>
        <span class="ref-note">~70% Middle East crude feedstock</span>
      </div>
      <div class="ref-row">
        <span>ðŸ‡¨ðŸ‡³ Rongsheng (Zhejiang)</span><span class="ref-cap">800K b/d</span>
        <span class="ref-note">Heavy Gulf crude dependency</span>
      </div>
      <div class="ref-row">
        <span>ðŸ‡¸ðŸ‡¬ Shell Pulau Bukom</span><span class="ref-cap">500K b/d</span>
        <span class="ref-note">Singapore hub Â· mixed sources</span>
      </div>
      <div class="ref-row">
        <span>ðŸ‡¯ðŸ‡µ ENEOS Negishi</span><span class="ref-cap">270K b/d</span>
        <span class="ref-note">~85% Middle East crude</span>
      </div>
      <div class="note" style="margin-top:6px">Asian refining complex (~35M b/d) faces feedstock crisis within 2-4 weeks of full closure. Product cracks (gasoline, diesel, jet fuel) spike globally.</div>
    </div>

    <!-- TIMEFRAME TO REOPEN -->
    <div class="sec">
      <div class="sec-label">Timeframe to Reopen â€” Scenarios <span class="src" style="margin-left:auto">(ONI / USN)</span></div>
      <div class="ts-row">
        <div class="ts-header">
          <span class="ts-scenario">Quick De-escalation</span>
          <span class="ts-time" style="color:var(--green)">48-72 hrs</span>
        </div>
        <div class="ts-detail">Diplomatic breakthrough Â· Iran backs down Â· Price spike +50%, rapid reversion</div>
      </div>
      <div class="ts-row">
        <div class="ts-header">
          <span class="ts-scenario">Mine Clearance Required</span>
          <span class="ts-time" style="color:var(--gold)">2-6 weeks</span>
        </div>
        <div class="ts-detail">Iran deploys mines in shipping lanes Â· US/UK MCM ops Â· Gradual reopening</div>
      </div>
      <div class="ts-row">
        <div class="ts-header">
          <span class="ts-scenario">Sustained Combat</span>
          <span class="ts-time" style="color:var(--warn)">1-3 months</span>
        </div>
        <div class="ts-detail">Active fighting in Gulf waters Â· IRGC fast-boat threat Â· Insurance blackout zone</div>
      </div>
      <div class="ts-row">
        <div class="ts-header">
          <span class="ts-scenario">Full Regional War</span>
          <span class="ts-time" style="color:var(--accent)">3-12 months</span>
        </div>
        <div class="ts-detail">Multi-front: Hezbollah, Houthis join Â· Infrastructure destroyed Â· Structural repricing</div>
      </div>
      <div class="note" style="margin-top:6px">Iran stockpiles ~6,000 naval mines (ONI est.). US 5th Fleet MCM: ~8-12 vessels. Full clearance: 4-8 weeks min. IRGC Navy operates 1,500+ fast-attack craft â€” can sustain harassment for months.</div>
    </div>

    <!-- ESCALATION TIMELINE -->
    <div class="sec">
      <div class="sec-label">Escalation Timeline</div>
      <div class="tl">
        <div class="tl-item"><div class="tl-dot" style="background:#3a4257"></div>
          <div class="tl-time">Nov 2022</div>
          <div class="tl-text">OPEC+ cuts reduce Saudi/Kuwait/UAE Hormuz flows by 1.6M b/d</div>
        </div>
        <div class="tl-item"><div class="tl-dot" style="background:#3a4257"></div>
          <div class="tl-time">Late 2025</div>
          <div class="tl-text">Iran economic collapse; nationwide protests begin against the government</div>
        </div>
        <div class="tl-item"><div class="tl-dot" style="background:var(--gold)"></div>
          <div class="tl-time">Jan 13, 2026</div>
          <div class="tl-text">Iran: "ready for war." US amasses air/naval assets at scale not seen since 2003 Iraq invasion</div>
        </div>
        <div class="tl-item"><div class="tl-dot" style="background:var(--gold)"></div>
          <div class="tl-time">Jan 28, 2026</div>
          <div class="tl-text">Trump on Truth Social: "A massive Armada is heading to Iran"</div>
        </div>
        <div class="tl-item"><div class="tl-dot" style="background:var(--warn)"></div>
          <div class="tl-time">Feb 3, 2026</div>
          <div class="tl-text">6 IRGC gunboats attempt to seize US tanker in Hormuz. F-35 shoots down Iranian Shahed-139 drone approaching USS Abraham Lincoln</div>
        </div>
        <div class="tl-item"><div class="tl-dot" style="background:var(--warn)"></div>
          <div class="tl-time">Feb 5, 2026</div>
          <div class="tl-text">IRGC seizes two foreign oil tankers near Farsi Island, transfers to Bushehr port</div>
        </div>
        <div class="tl-item"><div class="tl-dot" style="background:var(--warn)"></div>
          <div class="tl-time">Feb 17, 2026</div>
          <div class="tl-text">Khamenei threatens US warships. Hormuz closed several hours during live Iranian military drill</div>
        </div>
        <div class="tl-item"><div class="tl-dot" style="background:var(--accent)"></div>
          <div class="tl-time">Feb 24, 2026</div>
          <div class="tl-text">Trump State of the Union: Iran reviving nuclear weapons. Missiles reaching Europe. Issues final ultimatum</div>
        </div>
        <div class="tl-item tl-live"><div class="tl-dot" style="background:var(--accent);box-shadow:0 0 6px var(--accent)"></div>
          <div class="tl-time">FEB 28, 2026 â€” NOW</div>
          <div class="tl-text">US &amp; Israel launch joint military strikes. Iran retaliates. Middle East in full conflict.</div>
        </div>
      </div>
    </div>

  </div>

</div>

<script>
// â”€â”€ DARK MAP â”€â”€
const map = L.map('map', {
  center: [28, 54],
  zoom: 5.2,
  zoomControl: true,
  attributionControl: true
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  subdomains: 'abc',
  maxZoom: 18
}).addTo(map);

const styleEl = document.createElement('style');
styleEl.textContent = `
  .leaflet-tile-pane {
    filter: invert(1) hue-rotate(195deg) brightness(0.75) saturate(0.55) contrast(1.15);
  }
`;
document.head.appendChild(styleEl);

// â”€â”€ HELPERS â”€â”€
function mkPulse(latlng, color, sz, delay, tipHtml) {
  const s = sz, S = s + 4;
  const icon = L.divIcon({
    className: '',
    iconSize: [S*2, S*2], iconAnchor: [S, S],
    html: `<div style="position:relative;width:${S*2}px;height:${S*2}px">
      <div style="position:absolute;inset:0;border-radius:50%;background:${color};opacity:.15;
        animation:pulse-ring 1.8s ease-out ${delay}s infinite"></div>
      <div style="position:absolute;inset:0;border-radius:50%;background:${color};opacity:.1;
        animation:pulse-ring2 1.8s ease-out ${delay+.6}s infinite"></div>
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
        width:${s}px;height:${s}px;border-radius:50%;background:${color};
        box-shadow:0 0 ${s}px ${color}88"></div>
    </div>`
  });
  const m = L.marker(latlng, {icon}).addTo(map);
  if (tipHtml) m.bindPopup(`<div class="map-tip">${tipHtml}</div>`, {maxWidth:260, closeButton:false});
  return m;
}

function mkCity(latlng, name, color='#8899aa', r=4) {
  const icon = L.divIcon({
    className:'', iconSize:[0,0], iconAnchor:[0,r],
    html:`<div style="display:flex;align-items:center;gap:3px;white-space:nowrap">
      <div style="width:${r*2}px;height:${r*2}px;border-radius:50%;background:${color};opacity:.65;flex-shrink:0"></div>
      <span style="font-family:'IBM Plex Mono',monospace;font-size:7px;color:${color};opacity:.8;letter-spacing:.5px;text-shadow:0 0 3px #000,0 0 6px #000">${name}</span>
    </div>`
  });
  L.marker(latlng,{icon,interactive:false}).addTo(map);
}

function mkLabel(latlng, html) {
  const icon = L.divIcon({
    className:'', iconSize:[0,0], iconAnchor:[0,0],
    html:`<div style="pointer-events:none;white-space:nowrap;text-shadow:1px 1px 4px #000,0 0 8px #000">${html}</div>`
  });
  L.marker(latlng,{icon,interactive:false}).addTo(map);
}

function line(coords, color, dash, w=2, op=0.7, popupHtml) {
  const pl = L.polyline(coords, {color, weight:w, opacity:op, dashArray:dash}).addTo(map);
  if (popupHtml) pl.bindPopup(`<div class="map-tip">${popupHtml}</div>`, {maxWidth:280, closeButton:false});
  return pl;
}

function arrowHead(latlng, color) {
  const icon = L.divIcon({
    className:'', iconSize:[14,14], iconAnchor:[7,7],
    html:`<div style="width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:10px solid ${color};opacity:.8;margin-top:2px"></div>`
  });
  L.marker(latlng,{icon,interactive:false}).addTo(map);
}

// â”€â”€ REGION LABELS â”€â”€
mkLabel([32, 52], `<span style="font-family:'Bebas Neue',sans-serif;font-size:22px;color:rgba(230,57,70,.45);letter-spacing:2px">IRAN</span>`);
mkLabel([33.5, 52.5], `<span style="font-family:'IBM Plex Mono',monospace;font-size:8px;color:rgba(230,57,70,.5);letter-spacing:2px">âš  ACTIVE COMBAT ZONE</span>`);
mkLabel([24, 43.5], `<span style="font-family:'Bebas Neue',sans-serif;font-size:13px;color:rgba(255,255,255,.18);letter-spacing:1px">SAUDI ARABIA</span>`);
mkLabel([33, 43], `<span style="font-family:'Bebas Neue',sans-serif;font-size:12px;color:rgba(255,255,255,.18)">IRAQ</span>`);
mkLabel([23.5, 57], `<span style="font-family:'Bebas Neue',sans-serif;font-size:11px;color:rgba(255,255,255,.15)">OMAN</span>`);
mkLabel([30, 66], `<span style="font-family:'Bebas Neue',sans-serif;font-size:11px;color:rgba(255,255,255,.12)">PAKISTAN</span>`);

// â”€â”€ HORMUZ LABELS â”€â”€
mkLabel([26.7, 56.3], `<span style="font-family:'IBM Plex Mono',monospace;font-size:9.5px;color:#a8dadc;letter-spacing:1px">â€” STRAIT OF HORMUZ â€”</span>`);
mkLabel([26.35, 56.5], `<span style="font-family:'IBM Plex Mono',monospace;font-size:7.5px;color:rgba(168,218,220,.5)">21 NM NAVIGABLE WIDTH</span>`);

// â”€â”€ VOLUME CALLOUT ON HORMUZ â”€â”€
const volIcon = L.divIcon({
  className:'', iconSize:[140,48], iconAnchor:[70,56],
  html:`<div style="background:rgba(7,9,15,.92);border:1px solid #f4a261;border-radius:4px;padding:7px 12px;text-align:center">
    <div style="font-family:'IBM Plex Mono',monospace;font-size:7.5px;color:#5a6278;letter-spacing:1px">DAILY FLOW AT RISK</div>
    <div style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:#f4a261;line-height:1.1">20 MILLION b/d</div>
  </div>`
});
L.marker([19.5, 57.5], {icon:volIcon, interactive:false}).addTo(map);

// â”€â”€ TANKER ROUTES â”€â”€
line([
  [26.6,48.5],[26.8,50.5],[26.7,52.5],[26.7,55.5],[26.5,57.2],
  [25.3,58.5],[23,60],[20,63],[16,68],[13,72],[10,76],[7,82]
], '#f4a261', '10 5', 2.5, 0.75,
  `<strong>Outbound Tanker Route</strong><span class="tip-gold">Persian Gulf â†’ Gulf of Oman â†’ Indian Ocean â†’ Asia<br>Primary crude export corridor<br>~20M b/d total flow (crude + products + LNG)<br><span style="color:#5a6278">VLCC transit time through Hormuz: ~6 hours</span></span>`
);

line([
  [26.3,48.5],[26.5,50.5],[26.4,52.5],[26.4,55],[26.2,57],
  [25,58],[22.5,60.5],[19.5,63.5],[15.5,68.5],[12.5,72.5],[9.5,76.5]
], '#457b9d', '6 5', 1.5, 0.4,
  `<strong>Inbound Tanker Route</strong><span class="tip-blue">Return route for empty/ballast tankers<br>~2-lane traffic separation scheme<br><span style="color:#5a6278">Inbound lane: 2 NM wide Â· Outbound: 2 NM wide Â· Median: 2 NM</span></span>`
);

// â”€â”€ BYPASS PIPELINES (with interactive popups) â”€â”€
// Saudi E-W: Abqaiq to Yanbu
line([
  [26.0, 49.7], [25.2, 47.8], [24.0, 45.5], [23.2, 42.8], [24.09, 38.05]
], '#52b788', '7 4', 2.5, 0.75,
  `<strong>ðŸ‡¸ðŸ‡¦ Saudi East-West Pipeline (Petroline)</strong>
  <span class="tip-green">
  <strong>Route:</strong> Abqaiq â†’ Yanbu (Red Sea port)<br>
  <strong>Capacity:</strong> 5M b/d (max 7M surge)<br>
  <strong>Current use:</strong> ~2.6M b/d<br>
  <strong>Available spare:</strong> ~2.4M b/d<br>
  <strong>Ramp-up time:</strong> Days (already operational)<br>
  <strong>Length:</strong> ~1,200 km<br><br>
  <span style="color:#f4a261">âš  Most important bypass. But even at max capacity, only replaces 25% of Hormuz flow. Yanbu port infrastructure is the bottleneck â€” loading berths designed for ~3M b/d.</span>
  </span>`
);

// UAE Fujairah bypass
line([
  [24.35, 54.4], [23.9, 55.2], [23.2, 56.0], [25.12, 56.34]
], '#2a9d8f', '5 3', 2, 0.7,
  `<strong>ðŸ‡¦ðŸ‡ª Abu Dhabi Crude Oil Pipeline (ADCOP)</strong>
  <span class="tip-teal">
  <strong>Route:</strong> Habshan â†’ Fujairah (Gulf of Oman)<br>
  <strong>Capacity:</strong> 1.8M b/d<br>
  <strong>Current use:</strong> ~1.5M b/d<br>
  <strong>Available spare:</strong> ~300K b/d<br>
  <strong>Ramp-up time:</strong> Limited â€” already near capacity<br>
  <strong>Length:</strong> ~360 km<br><br>
  <span style="color:#f4a261">âš  Already running near-full. Cannot meaningfully scale. Fujairah is outside Hormuz but vulnerable to Iranian missile/drone attack from nearby coast.</span>
  </span>`
);

// Goreh-Jask
line([
  [29.45, 50.9], [28.6, 52.5], [27.5, 54.5], [25.65, 57.78]
], '#5a6278', '3 5', 1.5, 0.4,
  `<strong>ðŸ‡®ðŸ‡· Goreh-Jask Pipeline</strong>
  <span style="color:#5a6278">
  <strong>Route:</strong> Goreh â†’ Jask (Gulf of Oman)<br>
  <strong>Capacity:</strong> 300K b/d (designed for 1M)<br>
  <strong>Status:</strong> <span style="color:#e63946">INACTIVE since Sep 2024</span><br>
  <strong>Available spare:</strong> 0 b/d<br><br>
  <span style="color:#e63946">âš  Iranian-operated â€” would be offline in any conflict scenario regardless. Never reached design capacity.</span>
  </span>`
);

// â”€â”€ PIPELINE TERMINALS â”€â”€
mkPulse([26.0, 49.7], '#52b788', 7, 0,
  `<strong>Abqaiq Processing Hub</strong><span class="tip-green">World's largest oil processing facility<br>Start of E-W Pipeline bypass<br>Processes ~7M b/d of Saudi crude<br><span style="color:#5a6278">Attacked by Houthi drones Sep 2019 â€” 5.7M b/d offline for weeks</span></span>`);
mkPulse([24.09, 38.05], '#52b788', 7, 0.5,
  `<strong>Yanbu, Red Sea</strong><span class="tip-green">Saudi E-W pipeline terminus<br>5M b/d pipeline capacity (7M max surge)<br>Red Sea export â€” bypasses Hormuz entirely<br><span style="color:#5a6278">Bottleneck: port loading capacity ~3M b/d</span></span>`);
mkPulse([25.12, 56.34], '#2a9d8f', 6, 0.3,
  `<strong>Fujairah Terminal, UAE</strong><span class="tip-teal">UAE ADCOP pipeline terminus<br>1.8M b/d capacity (near full at ~1.5M)<br>Gulf of Oman â€” outside Hormuz chokepoint<br><span style="color:#5a6278">âš  Only ~65km from Iranian coast â€” vulnerable to ASCM/drone attack</span></span>`);
mkPulse([25.65, 57.78], '#5a6278', 5, 0,
  `<strong>Jask Terminal, Iran</strong><span style="color:#5a6278">Goreh-Jask pipeline terminus<br>Inactive since Sep 2024<br>Would be offline in any conflict scenario</span>`);

// â”€â”€ STRIKE SITES â€” US/Israeli (red) â”€â”€
mkPulse([35.69, 51.39], '#e63946', 9, 0,
  `<strong>Tehran âš¡ STRUCK</strong><span class="tip-red">US/Israeli joint strike Â· Multiple sites hit<br>Near Khamenei's offices Â· Smoke rising<br>Missiles on University St &amp; Jomhouri area</span>`);
mkPulse([33.35, 44.4], '#e63946', 7, 0.4,
  `<strong>Baghdad âš¡ Kata'ib Hezbollah HQ</strong><span class="tip-red">Iran-backed paramilitary HQ struck<br>Near Baghdad, Iraq</span>`);
mkPulse([33.6, 46.3], '#e63946', 6, 0.7,
  `<strong>Ilam Province âš¡</strong><span class="tip-red">Western Iran Â· Israeli airstrike confirmed<br>Military and defense sites targeted</span>`);
mkPulse([27.1, 57.08], '#e63946', 6, 1.0,
  `<strong>Minab, Hormozgan âš¡</strong><span class="tip-red">Near Strait of Hormuz Â· Southern Iran<br>Elementary school struck Â· 40+ killed (IRNA)</span>`);
mkPulse([28.92, 50.83], '#e63946', 6, 0.3,
  `<strong>Bushehr Region âš¡</strong><span class="tip-red">Nuclear &amp; military infrastructure<br>Major target site</span>`);
mkPulse([36.32, 59.56], '#e63946', 5, 0.6,
  `<strong>Mashhad âš¡</strong><span class="tip-red">Iran's second city Â· Strikes reported</span>`);

// â”€â”€ IRANIAN COUNTER-STRIKES (orange) â”€â”€
mkPulse([26.22, 50.59], '#ff6b35', 8, 0.5,
  `<strong>Manama, Bahrain âš¡ COUNTER-STRIKE</strong><span class="tip-orange">Iranian missiles strike US Navy HQ<br>US 5th Fleet headquarters</span>`);
mkPulse([32.8, 35.1], '#ff6b35', 6, 0.9,
  `<strong>Northern Israel âš¡</strong><span class="tip-orange">Iranian retaliatory missile strikes<br>Air defenses intercept; multiple impacts</span>`);

// â”€â”€ US NAVAL ASSETS (blue) â”€â”€
mkPulse([23.5, 60.5], '#457b9d', 7, 0,
  `<strong>USS Abraham Lincoln (CVN-72)</strong><span class="tip-blue">Carrier Strike Group Â· Gulf of Oman<br>F-35 shot down Iranian drone Feb 3<br><span style="color:#5a6278">~70 aircraft Â· Aegis escort screen</span></span>`);
mkPulse([24.9, 58.2], '#457b9d', 6, 0.6,
  `<strong>USS McFaul (DDG-74)</strong><span class="tip-blue">Guided missile destroyer<br>Escorted US tanker through Hormuz, Feb 3<br><span style="color:#5a6278">96 VLS cells Â· SM-2/SM-6 air defense</span></span>`);
mkPulse([25.2, 56.7], '#457b9d', 6, 1.2,
  `<strong>2nd CVN Strike Group</strong><span class="tip-blue">Additional carrier force deployed<br>Gulf of Oman / Arabian Sea<br><span style="color:#5a6278">MCM assets embarked for mine countermeasures</span></span>`);

// â”€â”€ CITIES â”€â”€
mkCity([35.69, 51.39], 'Tehran', '#cc4455', 5);
mkCity([32.66, 51.68], 'Isfahan', '#8899aa');
mkCity([29.61, 52.53], 'Shiraz', '#8899aa');
mkCity([32.0, 48.69], 'Ahvaz', '#8899aa');
mkCity([38.06, 46.3], 'Tabriz', '#8899aa');
mkCity([24.69, 46.72], 'Riyadh', '#f4a261', 5);
mkCity([33.34, 44.4], 'Baghdad', '#f4a261', 5);
mkCity([25.29, 51.53], 'Doha', '#8899aa');
mkCity([29.37, 47.98], 'Kuwait City', '#8899aa');
mkCity([26.22, 50.59], 'Manama', '#ff6b35', 5);
mkCity([23.62, 58.59], 'Muscat', '#8899aa');
mkCity([24.45, 54.38], 'Abu Dhabi', '#8899aa');
mkCity([25.26, 55.3], 'Dubai', '#8899aa');
mkCity([27.1, 57.08], 'Bandar Abbas', '#8899aa', 3);

// â”€â”€ DATA LAYERS â”€â”€

// Helper: diamond marker for bases
function mkDiamond(latlng, color, tipHtml, flag) {
  const icon = L.divIcon({
    className:'', iconSize:[16,16], iconAnchor:[8,8],
    html:`<div style="font-size:13px;line-height:16px;text-align:center;filter:drop-shadow(0 0 3px #000)">${flag || 'ðŸ´'}</div>`
  });
  const m = L.marker(latlng, {icon});
  if (tipHtml) m.bindTooltip(`<div class="map-tip">${tipHtml}</div>`, {maxWidth:280, opacity:1, sticky:false});
  return m;
}

// Helper: nuclear marker
function mkNuke(latlng, color, tipHtml) {
  const icon = L.divIcon({
    className:'', iconSize:[16,16], iconAnchor:[8,8],
    html:`<div style="width:14px;height:14px;border-radius:50%;border:2px solid ${color};display:flex;align-items:center;justify-content:center;font-size:9px;opacity:.9;box-shadow:0 0 6px ${color}44">&#9762;</div>`
  });
  const m = L.marker(latlng, {icon});
  if (tipHtml) m.bindTooltip(`<div class="map-tip">${tipHtml}</div>`, {maxWidth:300, opacity:1, sticky:false});
  return m;
}

// â”€â”€ 1. MILITARY BASES â”€â”€
const BASES = [
  {lat:25.12, lon:51.32, name:'Al Udeid Air Base', country:'US', type:'Air Base', note:'Largest US air base in Middle East. CENTCOM forward HQ. ~10,000 personnel. Hosts B-52s, KC-135s, RQ-4 Global Hawks.'},
  {lat:24.25, lon:54.55, name:'Al Dhafra Air Base', country:'US/UAE', type:'Air Base', note:'Key USAF forward operating base. F-22 Raptors, F-35s deployed. MQ-9 Reaper drone ops. ~3,500 US personnel.'},
  {lat:29.35, lon:47.68, name:'Camp Arifjan', country:'US', type:'Army Base', note:'US Army Central (ARCENT) forward HQ. ~13,000 troops. Logistics hub for entire Gulf region.'},
  {lat:26.22, lon:50.59, name:'NSA Bahrain / 5th Fleet HQ', country:'US', type:'Naval Base', note:'US Naval Forces Central Command. 5th Fleet HQ. ~9,000 personnel. Controls all US naval ops in Persian Gulf.'},
  {lat:11.55, lon:43.15, name:'Camp Lemonnier', country:'US', type:'Joint Base', note:'Only permanent US base in Africa. ~4,000 personnel. Drone ops hub for Horn of Africa / Yemen.'},
  {lat:29.07, lon:47.52, name:'Ali Al Salem Air Base', country:'US/Kuwait', type:'Air Base', note:'Primary US air transit hub. ~3,000 US troops. F-16s, A-10s, KC-135s.'},
  {lat:-7.32, lon:72.42, name:'Diego Garcia', country:'US/UK', type:'Naval/Air', note:'B-2 bomber forward staging. Prepositioned maritime logistics. Indian Ocean power projection.'},
  {lat:21.43, lon:40.55, name:'Prince Sultan Air Base', country:'US/Saudi', type:'Air Base', note:'USAF reactivated 2019. Patriot batteries, F-15Es. ~2,500 US personnel.'},
  {lat:27.18, lon:56.28, name:'Bandar Abbas Naval Base', country:'Iran', type:'Naval Base', note:'IRIN main naval HQ. Fast attack craft, submarines, anti-ship missile batteries. Controls Hormuz approach.'},
  {lat:28.95, lon:50.82, name:'Bushehr Naval Base', country:'Iran', type:'Naval Base', note:'IRGC Navy base. Operates fast attack boats. Adjacent to Bushehr nuclear plant.'},
  {lat:25.65, lon:57.77, name:'Jask Naval Base', country:'Iran', type:'Naval Base', note:'Gulf of Oman access. Bypasses Hormuz for Iranian Navy ops. New submarine berths.'},
  {lat:25.29, lon:60.64, name:'Chabahar Naval Base', country:'Iran', type:'Naval Base', note:'Indian Ocean access. Velayat-class submarine base. Outside Persian Gulf.'},
  {lat:35.75, lon:51.30, name:'Khatam al-Anbiya HQ', country:'Iran', type:'Air Defense', note:'IRGC Aerospace Force & Air Defense HQ. Coordinates all Iranian air defense. S-300/Bavar-373 command.'},
  {lat:32.90, lon:51.70, name:'Isfahan Air Base (8th TAB)', country:'Iran', type:'Air Base', note:'F-14 Tomcat base. Houses Iran\'s most capable interceptors. Near nuclear facilities.'},
  {lat:20.26, lon:40.53, name:'King Faisal Naval Base', country:'Saudi', type:'Naval Base', note:'Royal Saudi Naval Forces Western Fleet HQ. Red Sea patrol. Near Jeddah.'},
  {lat:23.6, lon:57.05, name:'RAFO Musanah / Duqm', country:'Oman', type:'Naval/Air', note:'UK/US logistics access agreement. Growing strategic port. Outside Hormuz chokepoint.'},
];

const basesLayer = L.layerGroup();
BASES.forEach(b => {
  const flag = b.country.includes('US') ? '\u{1F1FA}\u{1F1F8}' : b.country.includes('Iran') ? '\u{1F1EE}\u{1F1F7}' : b.country.includes('Saudi') ? '\u{1F1F8}\u{1F1E6}' : b.country.includes('Oman') ? '\u{1F1F4}\u{1F1F2}' : '\u{1F3F4}';
  mkDiamond([b.lat, b.lon], '#6a8caf',
    `<strong>${flag} ${b.name}</strong><span class="tip-blue"><strong>Operator:</strong> ${b.country}<br><strong>Type:</strong> ${b.type}<br>${b.note}</span>`,
    flag
  ).addTo(basesLayer);
});
basesLayer.addTo(map);

// â”€â”€ 2. NUCLEAR FACILITIES â”€â”€
const NUCLEAR_SITES = [
  {lat:33.72, lon:51.73, name:'Natanz (FEP)', country:'Iran', type:'Uranium Enrichment', status:'Active \u2014 enriching to 60% U-235', note:'Primary enrichment facility. Underground halls with thousands of centrifuges. Target of Stuxnet (2010). IAEA monitored.'},
  {lat:34.36, lon:51.06, name:'Fordow (FFEP)', country:'Iran', type:'Uranium Enrichment', status:'Active \u2014 enriching to 60%', note:'Built inside mountain near Qom. Hardened against airstrikes. ~1,000 centrifuges. Detected by Western intel 2009.'},
  {lat:32.65, lon:51.66, name:'Isfahan (UCF)', country:'Iran', type:'Uranium Conversion', status:'Active', note:'Uranium Conversion Facility. Converts yellowcake to UF6 for enrichment. Also Zirconium Production Plant. IAEA monitored.'},
  {lat:28.83, lon:50.89, name:'Bushehr Nuclear Plant', country:'Iran', type:'Power Reactor', status:'Operational \u2014 1 GW', note:'Iran\'s only nuclear power reactor. Russian-built VVER-1000. Civilian electricity generation. IAEA safeguarded.'},
  {lat:34.37, lon:49.24, name:'Arak (IR-40)', country:'Iran', type:'Heavy Water Reactor', status:'Modified under JCPOA', note:'Heavy water research reactor. Originally plutonium-capable. Core modified under JCPOA (concrete-filled). Nearby heavy water production plant.'},
  {lat:35.52, lon:51.67, name:'Parchin Military Complex', country:'Iran', type:'Military/Testing', status:'Restricted access', note:'Military site suspected of past explosive testing related to nuclear warhead design. IAEA requested access \u2014 limited cooperation.'},
  {lat:35.74, lon:51.39, name:'Tehran Research Reactor', country:'Iran', type:'Research Reactor', status:'Active \u2014 5 MW', note:'US-built (1967) research reactor. Produces medical isotopes. Uses 20% enriched uranium fuel. Located at University of Tehran.'},
  {lat:23.96, lon:52.26, name:'Barakah Nuclear Plant', country:'UAE', type:'Power Reactor', status:'Operational \u2014 4 units (5.6 GW)', note:'First nuclear power plant in Arab world. Four APR-1400 reactors (Korean-built). IAEA safeguarded. Began ops 2021.'},
];

const nuclearLayer = L.layerGroup();
NUCLEAR_SITES.forEach(s => {
  const flag = s.country === 'Iran' ? '\u{1F1EE}\u{1F1F7}' : s.country === 'UAE' ? '\u{1F1E6}\u{1F1EA}' : '\u{1F3F4}';
  const statusColor = s.status.includes('Active') || s.status.includes('Operational') ? '#52b788' : s.status.includes('Restricted') ? '#e63946' : '#f4a261';
  mkNuke([s.lat, s.lon], '#c77dff',
    `<strong>${flag} ${s.name}</strong><span style="color:#c77dff"><br><strong>Type:</strong> ${s.type}<br><strong>Status:</strong> <span style="color:${statusColor}">${s.status}</span><br>${s.note}</span>`
  ).addTo(nuclearLayer);
});
nuclearLayer.addTo(map);

// â”€â”€ 3. NASA FIRMS FIRE HOTSPOTS â”€â”€
const firesLayer = L.layerGroup().addTo(map);
async function fetchFires() {
  try {
    const res = await fetch('/api/fires');
    if (!res.ok) throw new Error('fires api failed');
    const fires = await res.json();
    firesLayer.clearLayers();
    fires.forEach(f => {
      const r = f.brightness > 400 ? 4 : f.brightness > 350 ? 3 : 2.5;
      const op = f.confidence === 'high' ? 0.8 : f.confidence === 'nominal' ? 0.55 : 0.35;
      L.circleMarker([f.lat, f.lon], {
        radius: r, fillColor:'#ff4500', fillOpacity:op,
        color:'#ff4500', weight:0.5, opacity:op
      }).bindPopup(`<div class="map-tip"><strong>Fire Hotspot</strong><span style="color:#ff4500">Brightness: ${f.brightness} K<br>Confidence: ${f.confidence}<br>${f.datetime}</span></div>`, {maxWidth:220, closeButton:false})
      .addTo(firesLayer);
    });
  } catch(e) { /* silent \u2014 fires layer optional */ }
}
fetchFires();
setInterval(fetchFires, 15 * 60000);

// â”€â”€ 4. USGS EARTHQUAKES â”€â”€
const quakesLayer = L.layerGroup().addTo(map);
async function fetchQuakes() {
  try {
    const url = 'https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&minmagnitude=2.5&maxlatitude=42&minlatitude=12&maxlongitude=70&minlongitude=40&limit=50&orderby=time';
    const res = await fetch(url);
    if (!res.ok) throw new Error('usgs failed');
    const data = await res.json();
    quakesLayer.clearLayers();
    (data.features || []).forEach(f => {
      const [lon, lat, depth] = f.geometry.coordinates;
      const mag = f.properties.mag;
      const place = f.properties.place || 'Unknown';
      const time = f.properties.time;
      const r = mag >= 5 ? 8 : mag >= 4 ? 5.5 : 3.5;
      const color = mag >= 5 ? '#e63946' : mag >= 4 ? '#f4a261' : '#ffd166';
      const ago = timeAgo(new Date(time).toISOString());
      L.circleMarker([lat, lon], {
        radius:r, fillColor:color, fillOpacity:0.6,
        color:color, weight:1.5, opacity:0.8
      }).bindPopup(`<div class="map-tip"><strong>M${mag.toFixed(1)} Earthquake</strong><span style="color:${color}">${place}<br>Depth: ${depth.toFixed(1)} km<br>${ago}</span></div>`, {maxWidth:240, closeButton:false})
      .addTo(quakesLayer);
    });
  } catch(e) { /* silent */ }
}
fetchQuakes();
setInterval(fetchQuakes, 10 * 60000);

// â”€â”€ LAYER TOGGLE WIRING â”€â”€
document.getElementById('tog-bases').addEventListener('change', function() {
  this.checked ? map.addLayer(basesLayer) : map.removeLayer(basesLayer);
});
document.getElementById('tog-nuclear').addEventListener('change', function() {
  this.checked ? map.addLayer(nuclearLayer) : map.removeLayer(nuclearLayer);
});
document.getElementById('tog-fires').addEventListener('change', function() {
  this.checked ? map.addLayer(firesLayer) : map.removeLayer(firesLayer);
});
document.getElementById('tog-quakes').addEventListener('change', function() {
  this.checked ? map.addLayer(quakesLayer) : map.removeLayer(quakesLayer);
});

// â”€â”€ LIVE NEWS FEED â”€â”€
// Uses CORS proxies + DOMParser to fetch RSS XML directly (no rss2json dependency)
// Primary: Google News RSS (most reliable). Secondary: direct outlet RSS feeds.

const KEYWORDS = [
  'iran','hormuz','tehran','irgc','khamenei','persian gulf','middle east',
  'oil','crude','brent','opec','tanker','strait','nuclear','israel',
  'gulf','saudi','iraq','petroleum','energy','gas price','lng','qatar',
  'sanctions','military strike','war','conflict','missile','drone',
  'navy','pentagon','hezbollah','houthi','red sea',
  'pipeline','refinery','barrel','commodity','shipping'
];

// Google News RSS â€” each query returns ~100 items, so 2 feeds gives plenty of coverage
// Google News <source> tags give us real outlet names (Bloomberg, Reuters, Al Jazeera, etc.)
const GOOGLE_NEWS_FEEDS = [
  { url: 'https://news.google.com/rss/search?q=iran+hormuz+oil+strait+middle+east+when:7d&hl=en-US&gl=US&ceid=US:en', source: 'Google News' },
  { url: 'https://news.google.com/rss/search?q=oil+price+crude+OPEC+energy+when:3d&hl=en-US&gl=US&ceid=US:en', source: 'Google News' },
];

function isRelevant(item) {
  const text = ((item.title || '') + ' ' + (item.desc || '')).toLowerCase();
  return KEYWORDS.some(k => text.includes(k));
}

function timeAgo(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  if (isNaN(d)) return '';
  const mins = Math.round((Date.now() - d) / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  if (days === 1) return '1d ago';
  if (days < 7) return `${days}d ago`;
  return d.toLocaleDateString();
}

function stripHtml(s) {
  return (s || '').replace(/<[^>]*>/g, '').replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'").trim();
}

function alertClass(dateStr) {
  if (!dateStr) return '';
  const mins = Math.round((Date.now() - new Date(dateStr)) / 60000);
  if (mins < 60) return '';
  if (mins < 360) return 'gold';
  return 'teal';
}

// Parse RSS/Atom XML into items array using DOMParser
function parseRssXml(xmlText, source) {
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlText, 'text/xml');
    if (doc.querySelector('parsererror')) return [];

    const items = [];

    // Try RSS 2.0 <item> elements first
    const rssItems = doc.querySelectorAll('item');
    if (rssItems.length > 0) {
      rssItems.forEach(item => {
        const title = stripHtml(item.querySelector('title')?.textContent || '');
        const link = item.querySelector('link')?.textContent?.trim() || '';
        const desc = stripHtml(item.querySelector('description')?.textContent || '').slice(0, 180);
        const pubDate = item.querySelector('pubDate')?.textContent || '';
        // Google News wraps the real source in <source> tag
        const realSource = item.querySelector('source')?.textContent || source;
        if (title) {
          items.push({ title, desc, link, pubDate, source: realSource, relevant: false });
        }
      });
      return items;
    }

    // Try Atom <entry> elements
    const entries = doc.querySelectorAll('entry');
    entries.forEach(entry => {
      const title = stripHtml(entry.querySelector('title')?.textContent || '');
      const linkEl = entry.querySelector('link[href]');
      const link = linkEl ? linkEl.getAttribute('href') : '';
      const desc = stripHtml((entry.querySelector('summary') || entry.querySelector('content'))?.textContent || '').slice(0, 180);
      const pubDate = (entry.querySelector('published') || entry.querySelector('updated'))?.textContent || '';
      if (title) {
        items.push({ title, desc, link, pubDate, source, relevant: false });
      }
    });
    return items;
  } catch (e) {
    return [];
  }
}

// Fetch RSS XML via CORS proxy â€” race multiple proxies for speed
async function fetchRssXml(feedUrl) {
  const proxies = [
    `https://api.allorigins.win/raw?url=${encodeURIComponent(feedUrl)}`,
    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(feedUrl)}`,
  ];

  // Race all proxies â€” first text response wins
  try {
    return await Promise.any(proxies.map(async proxy => {
      const res = await fetchTimeout(proxy, 5000);
      if (!res.ok) throw new Error('not ok');
      const text = await res.text();
      // Sanity check â€” must look like XML
      if (!text.includes('<') || text.length < 100) throw new Error('not xml');
      return text;
    }));
  } catch (e) {}

  // Last resort: allorigins /get wrapper
  try {
    const res = await fetchTimeout(`https://api.allorigins.win/get?url=${encodeURIComponent(feedUrl)}`, 6000);
    if (res.ok) {
      const wrapper = await res.json();
      if (wrapper && wrapper.contents && wrapper.contents.includes('<')) return wrapper.contents;
    }
  } catch (e) {}

  return null;
}

async function fetchFeed(feed) {
  const xml = await fetchRssXml(feed.url);
  if (!xml) return [];
  const items = parseRssXml(xml, feed.source);
  items.forEach(item => { item.relevant = isRelevant(item); });
  return items;
}

function getSourceClass(source) {
  const s = (source || '').toLowerCase();
  if (s.includes('bloomberg')) return 's-bloomberg';
  if (s.includes('jazeera')) return 's-aljazeera';
  if (s.includes('sky')) return 's-sky';
  if (s.includes('bbc')) return 's-bbc';
  if (s.includes('reuters')) return 's-reuters';
  if (s.includes('guardian')) return 's-guardian';
  if (s.includes('nyt') || s.includes('times')) return 's-nyt';
  return 's-default';
}

function renderFeed(items) {
  const feed = document.getElementById('rss-feed');
  if (!items.length) {
    feed.innerHTML = `<div style="padding:12px 0;font-family:'IBM Plex Mono',monospace;font-size:9.5px;color:var(--muted);text-align:center">
      No matching headlines found right now.<br>
      <span style="font-size:8px">Retrying in 3 minutes...</span>
    </div>`;
    return;
  }

  feed.innerHTML = items.map(item => {
    const ac = alertClass(item.pubDate);
    const ta = timeAgo(item.pubDate);
    const srcClass = getSourceClass(item.source);
    return `<a href="${item.link || '#'}" target="_blank" rel="noopener" style="text-decoration:none;display:block;margin-bottom:6px">
      <div class="alert ${ac}" style="cursor:pointer">
        <div class="alert-t">${ta ? ta + ' Â· ' : ''}<span class="alert-src ${srcClass}">${item.source}</span></div>
        <div class="alert-b" style="font-size:9.5px"><strong>${item.title}</strong>${item.desc && item.desc !== item.title ? '<br><span style="opacity:.75">'+item.desc.slice(0,130)+(item.desc.length>130?'â€¦':'')+'</span>' : ''}</div>
      </div>
    </a>`;
  }).join('');

  const dot = document.getElementById('rss-dot');
  if (dot) dot.style.background = 'var(--green)';
  const upd = document.getElementById('rss-updated');
  if (upd) upd.textContent = 'Updated ' + new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}

async function loadRSS() {
  try {
    let items = null;

    // Primary: serverless endpoint (fastest, no CORS)
    try {
      const res = await fetchTimeout('/api/rss', 5000);
      if (res.ok) {
        const data = await res.json();
        if (data.items && data.items.length > 0) {
          items = data.items;
          // Tag relevance client-side
          items.forEach(item => { item.relevant = isRelevant(item); });
        }
      }
    } catch(e) {}

    // Fallback: CORS proxy fetch (for local dev or if serverless fails)
    if (!items) {
      const results = await Promise.allSettled(GOOGLE_NEWS_FEEDS.map(fetchFeed));
      items = results.filter(r => r.status === 'fulfilled').flatMap(r => r.value);
    }

    if (!items || items.length === 0) throw new Error('no items');

    // Deduplicate
    const seen = new Set();
    const deduped = items.filter(item => {
      const key = item.title.slice(0, 50).toLowerCase();
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    // Relevant first, then general â€” sorted by date
    const relevant = deduped.filter(i => i.relevant).sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
    const general = deduped.filter(i => !i.relevant).sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
    const combined = [...relevant.slice(0, 12), ...general.slice(0, Math.max(0, 15 - relevant.length))].slice(0, 15);

    renderFeed(combined);

    // Cache for instant load on revisit
    try { localStorage.setItem('rss_cache', JSON.stringify({ items: combined, ts: Date.now() })); } catch(e) {}
  } catch (e) {
    // Show cached headlines on failure
    try {
      const cached = JSON.parse(localStorage.getItem('rss_cache'));
      if (cached && cached.items && cached.items.length > 0) {
        renderFeed(cached.items);
        const upd = document.getElementById('rss-updated');
        if (upd) upd.textContent = 'Cached Â· retrying...';
        return;
      }
    } catch(e2) {}
    const feed = document.getElementById('rss-feed');
    feed.innerHTML = `<div style="padding:10px 0;font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--muted)">
      Could not load live feed.<br><span style="font-size:8px">Retrying in 3 min...</span>
    </div>`;
  }
}

// Show cached headlines instantly while fresh ones load
try {
  const cached = JSON.parse(localStorage.getItem('rss_cache'));
  if (cached && cached.items && (Date.now() - cached.ts < 600000)) {
    renderFeed(cached.items);
    const upd = document.getElementById('rss-updated');
    if (upd) upd.textContent = 'Cached Â· refreshing...';
  }
} catch(e) {}

// Load RSS (serverless endpoint = no proxy contention with prices)
loadRSS();
setInterval(loadRSS, 3 * 60 * 1000);

// Animate bars
setTimeout(() => {
  document.querySelectorAll('.bar-fg').forEach(f => {
    const w = f.dataset.w;
    f.style.width = w + '%';
  });
}, 600);

// Animate delayed bars (LNG section)
setTimeout(() => {
  document.querySelectorAll('.bar-fg-delayed').forEach(f => {
    const w = f.dataset.w;
    f.style.width = w + '%';
  });
}, 1200);

// â”€â”€ LIVE YAHOO FINANCE PRICES â”€â”€
const YF_TICKERS = [
  { symbol: 'BZ=F', name: 'Brent', elPrice: 'lp-brent-price', elChange: 'lp-brent-change', elCard: 'lp-brent' },
  { symbol: 'CL=F', name: 'WTI',   elPrice: 'lp-wti-price',   elChange: 'lp-wti-change',   elCard: 'lp-wti' },
  { symbol: 'TTF=F',name: 'TTF',   elPrice: 'lp-ttf-price',   elChange: 'lp-ttf-change',   elCard: 'lp-ttf' },
];

// â”€â”€ Show cached prices instantly, then refresh live â”€â”€
function loadCachedPrices() {
  try {
    const cached = JSON.parse(localStorage.getItem('yf_prices') || '{}');
    if (cached.ts && (Date.now() - cached.ts < 600000)) { // < 10 min old
      YF_TICKERS.forEach(ticker => {
        const q = cached[ticker.symbol];
        if (q) updatePriceCard(ticker, q);
        if (ticker.symbol === 'BZ=F' && q) updateScenarios(q.price);
      });
      const dot = document.getElementById('lp-status-dot');
      const tsEl = document.getElementById('lp-timestamp');
      if (dot) dot.className = 'lp-dot stale';
      if (tsEl) tsEl.textContent = 'Cached Â· refreshing...';
    }
  } catch(e) {}
}

function cachePrices(quotes) {
  try {
    const obj = { ts: Date.now() };
    Object.entries(quotes).forEach(([sym, q]) => { obj[sym] = q; });
    localStorage.setItem('yf_prices', JSON.stringify(obj));
  } catch(e) {}
}

// CORS proxies â€” race all in parallel, fastest wins
function fetchTimeout(url, ms) {
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), ms);
  return fetch(url, { signal: controller.signal }).finally(() => clearTimeout(timer));
}

async function tryProxy(proxyUrl) {
  const res = await fetchTimeout(proxyUrl, 7000);
  if (!res.ok) throw new Error('not ok');
  const text = await res.text();
  return JSON.parse(text);
}

async function fetchWithProxy(url) {
  const proxyUrls = [
    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
  ];
  // Race all proxies â€” first valid JSON wins
  try {
    return await Promise.any(proxyUrls.map(p => tryProxy(p)));
  } catch(e) {}
  // Last resort: allorigins /get wrapper
  try {
    const res = await fetchTimeout(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, 8000);
    if (res.ok) {
      const wrapper = await res.json();
      if (wrapper && wrapper.contents) return JSON.parse(wrapper.contents);
    }
  } catch(e) {}
  return null;
}

function parseYahooChart(data) {
  if (!data || !data.chart || !data.chart.result || !data.chart.result[0]) return null;
  const result = data.chart.result[0];
  const meta = result.meta;
  const closes = result.indicators?.quote?.[0]?.close || [];
  const validCloses = closes.filter(p => p !== null && p !== undefined);

  const price = meta.regularMarketPrice || validCloses[validCloses.length - 1];
  const prevClose = meta.chartPreviousClose || validCloses[validCloses.length - 2];
  if (!price || !prevClose) return null;
  const change = price - prevClose;
  const changePct = (change / prevClose) * 100;
  return {
    price: Math.round(price * 100) / 100,
    change: Math.round(change * 100) / 100,
    changePct: Math.round(changePct * 100) / 100,
    currency: meta.currency || 'USD',
  };
}

// Primary: all 3 quotes in one serverless call (fastest)
async function fetchAllQuotesServerless() {
  for (let attempt = 0; attempt < 2; attempt++) {
    try {
      const res = await fetchTimeout('/api/prices', 10000);
      if (res.ok) return await res.json();
    } catch(e) {}
  }
  return null;
}

// Fallback: individual quote via CORS proxy (for local dev or if serverless fails)
async function fetchYahooQuote(symbol) {
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?interval=1d&range=2d`;
  const data = await fetchWithProxy(url);
  return parseYahooChart(data);
}

function formatPrice(price, currency) {
  if (currency === 'EUR') return 'â‚¬' + price.toFixed(2);
  return '$' + price.toFixed(2);
}

function updatePriceCard(ticker, quote) {
  const cardEl = document.getElementById(ticker.elCard);
  const priceEl = document.getElementById(ticker.elPrice);
  const changeEl = document.getElementById(ticker.elChange);
  if (!priceEl || !changeEl || !cardEl) return;

  cardEl.classList.remove('lp-loading');
  priceEl.textContent = formatPrice(quote.price, quote.currency);

  const sign = quote.change >= 0 ? '+' : '';
  const arrow = quote.change >= 0 ? 'â–²' : 'â–¼';
  const changeTxt = `${arrow} ${sign}${quote.change.toFixed(2)} (${sign}${quote.changePct.toFixed(2)}%)`;
  changeEl.textContent = changeTxt;
  changeEl.className = 'lp-change ' + (quote.change > 0 ? 'up' : quote.change < 0 ? 'down' : 'flat');

  // Update ticker tape with live prices
  const tickerMap = { 'BZ=F': ['ticker-brent','ticker-brent2'], 'CL=F': ['ticker-wti','ticker-wti2'], 'TTF=F': ['ticker-ttf','ticker-ttf2'] };
  const ids = tickerMap[ticker.symbol];
  if (ids) {
    const txt = `${ticker.name}: ${formatPrice(quote.price, quote.currency)} ${changeTxt}`;
    ids.forEach(id => { const el = document.getElementById(id); if (el) el.textContent = txt; });
  }
}

function updateScenarios(brentPrice) {
  if (!brentPrice || brentPrice <= 0) return;
  const b = brentPrice;
  // WTI typically trades ~$4-5 below Brent
  const spread = 4;
  const w = b - spread;

  // Partial disruption: +25-45% (harassment, not full blockade â€” Abqaiq 2019 was +15% for 5.7M b/d)
  const p1b = Math.round(b * 1.25), p2b = Math.round(b * 1.45);
  const p1w = Math.round(w * 1.25), p2w = Math.round(w * 1.45);
  const partialEl = document.getElementById('ps-partial-prices');
  const partialNote = document.getElementById('ps-partial-note');
  if (partialEl) partialEl.innerHTML = `<span>Brent <strong style="color:var(--gold)">$${p1b}â€“${p2b}</strong></span><span>WTI <strong style="color:var(--gold)">$${p1w}â€“${p2w}</strong></span>`;
  if (partialNote) partialNote.textContent = `+25-45% from $${b.toFixed(0)} Â· Harassment, not full blockade Â· Naval escorts, SPR release`;

  // Full blockade: +55-100% (Kuwait 1990 was +130% for 4.3M b/d over 2mo â€” but demand destruction caps upside)
  const f1b = Math.round(b * 1.55), f2b = Math.round(b * 2.00);
  const f1w = Math.round(w * 1.55), f2w = Math.round(w * 2.00);
  const fullEl = document.getElementById('ps-full-prices');
  const fullNote = document.getElementById('ps-full-note');
  if (fullEl) fullEl.innerHTML = `<span>Brent <strong style="color:var(--accent)">$${f1b}â€“${f2b}</strong></span><span>WTI <strong style="color:var(--accent)">$${f1w}â€“${f2w}</strong></span>`;
  if (fullNote) fullNote.textContent = `+55-100% from $${b.toFixed(0)} Â· Mining/interdiction Â· Kuwait 1990 analog Â· Demand destruction onset ~$130-150`;

  // Extended regional war: +90-170% (1973 embargo territory â€” structural repricing)
  const e1b = Math.round(b * 1.90), e2b = Math.round(b * 2.70);
  const e1w = Math.round(w * 1.90), e2w = Math.round(w * 2.70);
  const extEl = document.getElementById('ps-extended-prices');
  const extNote = document.getElementById('ps-extended-note');
  if (extEl) extEl.innerHTML = `<span>Brent <strong style="color:#ff4444">$${e1b}â€“${e2b}+</strong></span><span>WTI <strong style="color:#ff4444">$${e1w}â€“${e2w}+</strong></span>`;
  if (extNote) extNote.textContent = `+90-170% from $${b.toFixed(0)} Â· Infrastructure destroyed Â· 1973 analog Â· Rationing / recession`;
}

async function loadLivePrices() {
  const dot = document.getElementById('lp-status-dot');
  const tsEl = document.getElementById('lp-timestamp');
  let anySuccess = false;
  const freshQuotes = {};

  // Try serverless endpoint first â€” single request, all 3 quotes
  const batch = await fetchAllQuotesServerless();
  if (batch) {
    YF_TICKERS.forEach(ticker => {
      const quote = batch[ticker.symbol];
      if (quote) {
        updatePriceCard(ticker, quote);
        freshQuotes[ticker.symbol] = quote;
        anySuccess = true;
        if (ticker.symbol === 'BZ=F') updateScenarios(quote.price);
      }
    });
  }

  // Fallback: individual CORS proxy calls for any missing quotes
  const missing = YF_TICKERS.filter(t => !freshQuotes[t.symbol]);
  if (missing.length > 0) {
    await Promise.allSettled(
      missing.map(async (ticker) => {
        const quote = await fetchYahooQuote(ticker.symbol);
        if (quote) {
          updatePriceCard(ticker, quote);
          freshQuotes[ticker.symbol] = quote;
          anySuccess = true;
          if (ticker.symbol === 'BZ=F') updateScenarios(quote.price);
        }
      })
    );
  }

  if (anySuccess) cachePrices(freshQuotes);

  if (dot) dot.className = anySuccess ? 'lp-dot' : 'lp-dot error';
  if (tsEl) {
    tsEl.textContent = anySuccess
      ? 'Updated ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'})
      : 'Failed to load â€” retrying...';
  }

  // Retry quickly on failure instead of waiting 60s
  if (!anySuccess) setTimeout(loadLivePrices, 10000);
}

// Show cached prices instantly, then fetch fresh
loadCachedPrices();
loadLivePrices();
setInterval(loadLivePrices, 60 * 1000);

// â”€â”€ MOBILE: force map to recalculate size â”€â”€
window.addEventListener('resize', () => { map.invalidateSize(); });
setTimeout(() => { map.invalidateSize(); }, 500);

// â”€â”€ LIVE UTC CLOCK â”€â”€
function updateUTC() {
  const el = document.getElementById('live-utc');
  if (!el) return;
  const now = new Date();
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const m = months[now.getUTCMonth()];
  const d = now.getUTCDate();
  const y = now.getUTCFullYear();
  const h = String(now.getUTCHours()).padStart(2,'0');
  const min = String(now.getUTCMinutes()).padStart(2,'0');
  el.textContent = `${m} ${d}, ${y} Â· ${h}:${min} UTC`;
}
updateUTC();
setInterval(updateUTC, 60000);

// â”€â”€ SERVICE WORKER (PWA) â”€â”€
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// â”€â”€ LIVE TV â”€â”€
const LTV_CHANNELS = [
  { handle: '@AlJazeeraEnglish', name: 'Al Jazeera',  fallback: 'gCNeDWCI0vo' },
  { handle: '@Bloomberg',        name: 'Bloomberg',    fallback: 'iEpJwprxDdk' },
  { handle: '@SkyNews',          name: 'Sky News',     fallback: 'YDvsBbKfLPA' },
];

let ltvOrder = [1, 0, 2];
let ltvVideoIds = LTV_CHANNELS.map(c => c.fallback);
let ltvMuted = false;
let ltvPrimaryPlayer = null;
let ltvThumbPlayers = [null, null];

window.onYouTubeIframeAPIReady = function() {
  const loadingEl = document.getElementById('ltv-loading');

  ltvPrimaryPlayer = new YT.Player('ltv-player-primary', {
    videoId: ltvVideoIds[ltvOrder[0]],
    host: 'https://www.youtube-nocookie.com',
    playerVars: { autoplay:1, mute:1, controls:0, rel:0, modestbranding:1, playsinline:1, enablejsapi:1 },
    events: {
      onReady: function() {
        if (loadingEl) loadingEl.style.display = 'none';
        // Browsers block unmuted autoplay â€” start muted, unmute on first click
        if (!ltvMuted) { ltvPrimaryPlayer.unMute(); }
      },
      onError: function() { if (loadingEl) loadingEl.querySelector('span').textContent = 'Stream unavailable'; }
    }
  });

  for (let i = 0; i < 2; i++) {
    ltvThumbPlayers[i] = new YT.Player('ltv-player-thumb' + i, {
      videoId: ltvVideoIds[ltvOrder[i + 1]],
      host: 'https://www.youtube-nocookie.com',
      playerVars: { autoplay:1, mute:1, controls:0, rel:0, modestbranding:1, playsinline:1, enablejsapi:1 },
    });
  }
};

function swapLtvChannel(thumbIndex) {
  const oldPrimary = ltvOrder[0];
  ltvOrder[0] = ltvOrder[thumbIndex + 1];
  ltvOrder[thumbIndex + 1] = oldPrimary;

  if (ltvPrimaryPlayer && ltvPrimaryPlayer.loadVideoById) {
    ltvPrimaryPlayer.loadVideoById(ltvVideoIds[ltvOrder[0]]);
    if (!ltvMuted) ltvPrimaryPlayer.unMute(); else ltvPrimaryPlayer.mute();
  }
  if (ltvThumbPlayers[thumbIndex] && ltvThumbPlayers[thumbIndex].loadVideoById) {
    ltvThumbPlayers[thumbIndex].loadVideoById(ltvVideoIds[ltvOrder[thumbIndex + 1]]);
    ltvThumbPlayers[thumbIndex].mute();
  }

  document.getElementById('ltv-primary-name').textContent = LTV_CHANNELS[ltvOrder[0]].name;
  for (let i = 0; i < 2; i++) {
    document.getElementById('ltv-thumb-label-' + i).textContent = LTV_CHANNELS[ltvOrder[i + 1]].name;
  }
}

function toggleLtvMute() {
  ltvMuted = !ltvMuted;
  const btn = document.getElementById('ltv-mute-btn');
  if (ltvPrimaryPlayer) {
    if (ltvMuted) { ltvPrimaryPlayer.mute(); btn.textContent = 'Unmute'; btn.classList.remove('unmuted'); }
    else { ltvPrimaryPlayer.unMute(); btn.textContent = 'Mute'; btn.classList.add('unmuted'); }
  }
}

// Poll for live video IDs every 5 min
async function pollLtvStreams() {
  try {
    const res = await fetchTimeout('/api/youtube-live', 8000);
    if (!res.ok) return;
    const data = await res.json();
    LTV_CHANNELS.forEach((ch, i) => {
      const info = data[ch.handle];
      if (info && info.videoId && info.videoId !== ltvVideoIds[i]) {
        ltvVideoIds[i] = info.videoId;
        const slot = ltvOrder.indexOf(i);
        if (slot === 0 && ltvPrimaryPlayer && ltvPrimaryPlayer.loadVideoById) {
          ltvPrimaryPlayer.loadVideoById(info.videoId);
        } else if (slot > 0 && ltvThumbPlayers[slot - 1] && ltvThumbPlayers[slot - 1].loadVideoById) {
          ltvThumbPlayers[slot - 1].loadVideoById(info.videoId);
        }
      }
    });
  } catch(e) {}
}
setTimeout(pollLtvStreams, 3000);
setInterval(pollLtvStreams, 5 * 60 * 1000);

</script>
<script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
